define("XooMLExceptions.js",[],function(){"use strict";return{notImplemented:"NotImplementedException",missingParameter:"MissingParameterException",nullArgument:"NullArgumentException",invalidType:"InvalidTypeException",invalidState:"InvalidStateArgument",xooMLUException:"XooMLUException",itemUException:"ItemUException",nonUpgradeableAssociationException:"NonUpgradeableAssociationException",invalidArgument:"InvalidOptionsException",itemAlreadyExists:"ItemAlreadyExistsException",itemMirrorNotCurrent:"ItemMirrorNotCurrent"}}),define("XooMLConfig.js",[],function(){"use strict";return{schemaVersion:"0.54",schemaLocation:"http://kftf.ischool.washington.edu/xmlns/xooml",xooMLFragmentFileName:"XooML2.xml",maxFileLength:50,createAssociationSimple:{displayText:!0},createAssociationLinkNonGrouping:{displayText:!0,itemURI:!0,localItemRequested:!1},createAssociationLinkGrouping:{displayText:!0,groupingItemURI:!0,xooMLDriverURI:!0},createAssociationCreate:{displayText:!0,itemName:!0,isGroupingItem:!0}}}),define("XooMLUtil.js",["./XooMLExceptions.js","./XooMLConfig.js"],function(XooMLExceptions){"use strict";var _TYPES={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object","[object Error]":"error"},XooMLUtil={hasOptions:function(checkedOptions,options){if(!checkedOptions||!options)throw XooMLExceptions.nullArgument;if(!XooMLUtil.isObject(checkedOptions)||!XooMLUtil.isObject(options))throw XooMLExceptions.invalidType;var checkedOption,isRequiredOption,missingOptionalParamCount;if(missingOptionalParamCount=0,!(Object.keys(options).length<=Object.keys(checkedOptions).length))return!1;for(checkedOption in checkedOptions)if(checkedOptions.hasOwnProperty(checkedOption)&&(isRequiredOption=checkedOptions[checkedOption],!options.hasOwnProperty(checkedOption))){if(isRequiredOption)return!1;missingOptionalParamCount+=1}return Object.keys(options).length<=Object.keys(checkedOptions).length-missingOptionalParamCount},checkCallback:function(callback){if(!callback)throw XooMLExceptions.nullArgument;if(!XooMLUtil.isFunction(callback))throw XooMLExceptions.invalidType},isGUID:function(GUID){return"string"===XooMLUtil.getType(GUID)?!0:!1},isArray:function(value){return"array"===XooMLUtil.getType(value)},isObject:function(value){return"object"===XooMLUtil.getType(value)},isFunction:function(value){return null!==value},isString:function(value){return"string"===XooMLUtil.getType(value)},isBoolean:function(value){return"boolean"===XooMLUtil.getType(value)},generateGUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0,v="x"==c?r:3&r|8;return v.toString(16)})},getType:function(obj){return null==obj?String(obj):"object"==typeof obj||"function"==typeof obj?_TYPES[obj.toString()]||"object":typeof obj},endsWith:function(string,suffix){return-1!==string.indexOf(suffix,string.length-suffix.length)},clone:function(obj){if(null==obj||"object"!=typeof obj)return obj;if(obj instanceof Date){var copy=new Date;return copy.setTime(obj.getTime()),copy}if(obj instanceof Array){for(var copy=[],i=0,len=obj.length;len>i;i++)copy[i]=XooMLUtil.clone(obj[i]);return copy}if(obj instanceof Object){var copy={};for(var attr in obj)obj.hasOwnProperty(attr)&&(copy[attr]=XooMLUtil.clone(obj[attr]));return copy}throw XooMLExceptions.invalidType}};return XooMLUtil}),define("PathDriver.js",["./XooMLExceptions.js","./XooMLConfig.js","./XooMLUtil.js"],function(XooMLExceptions,XooMLConfig,XooMLUtil){"use strict";function PathDriver(){}var self,_PATH_SEPARATOR="/";return self=PathDriver.prototype,self.joinPath=function(rootPath,leafPath){var self=this;return rootPath===_PATH_SEPARATOR?leafPath:(rootPath=self._stripTrailingSlash(rootPath),leafPath=self._stripLeadingSlash(leafPath),rootPath+_PATH_SEPARATOR+leafPath)},self.joinPathArray=function(){throw XooMLExceptions.notImplemented},self.splitPath=function(path){return path.split(_PATH_SEPARATOR)},self.formatPath=function(path){return self._stripTrailingSlash(path)},self.isRoot=function(path){return path===_PATH_SEPARATOR},self.getPathSeparator=function(){return _PATH_SEPARATOR},self._stripTrailingSlash=function(path){var strippedPath;return path===_PATH_SEPARATOR?path:(strippedPath=path,XooMLUtil.endsWith(strippedPath,_PATH_SEPARATOR)&&(strippedPath=strippedPath.substring(0,strippedPath.length-1)),strippedPath)},self._stripLeadingSlash=function(path){var strippedPath;return path===_PATH_SEPARATOR?path:(strippedPath=path,0===path.indexOf(_PATH_SEPARATOR)&&(strippedPath=strippedPath.substring(1)),strippedPath)},new PathDriver}),define("XooMLAssociation.js",["./XooMLExceptions.js","./XooMLConfig.js","./XooMLUtil.js"],function(XooMLExceptions,XooMLConfig,XooMLUtil){"use strict";function XooMLAssociation(isGroupingItem,displayText){if(!XooMLUtil.isBoolean(isGroupingItem)||!XooMLUtil.isString(displayText))throw XooMLExceptions.invalidType;this._isGroupingItem=isGroupingItem,this._displayText=displayText}var self;return self=XooMLAssociation.prototype,self.getIsGroupingItem=function(){return this._isGroupingItem},self.getDisplayText=function(){return this._displayText},XooMLAssociation}),define("FragmentEditor.js",["./XooMLExceptions.js","./XooMLConfig.js","./XooMLUtil.js","./PathDriver.js","./XooMLAssociation.js"],function(XooMLExceptions,XooMLConfig,XooMLUtil,PathDriver){"use strict";function FragmentEditor(options,callback){if(XooMLUtil.checkCallback(callback),!options)return callback(XooMLExceptions.nullArgument);if(!XooMLUtil.isObject(options))return callback(XooMLExceptions.invalidType);var self=this;return XooMLUtil.hasOptions(_CONSTRUCTOR_CASE_1_OPTIONS,options)?(self._document=self._parseXML(options.xooMLFragmentString),callback(!1,self)):XooMLUtil.hasOptions(_CONSTRUCTOR_CASE_2_OPTIONS,options)?(self._document=self._createXooMLFragment(options.associations,options.xooMLUtilityURI,options.itemUtilityURI,options.syncUtilityURI,options.groupingItemURI),callback(!1,self)):callback(XooMLExceptions.missingParameter)}var self,_NAMESPACE_ATTRIBUTE="xmlns",_FRAGMENT="fragment",_FRAGMENT_NAMESPACE_DATA="fragmentNamespaceData",_FRAGMENT_SCHEMA_VERSION="schemaVersion",_FRAGMENT_SCHEMA_LOCATION="schemaLocation",_FRAGMENT_ITEM_DESCRIBED="itemDescribed",_ITEM_DESCRIBED=".",_FRAGMENT_ITEM_DRIVER="itemDriver",_FRAGMENT_SYNC_DRIVER="syncDriver",_FRAGMENT_XOOML_DRIVER="xooMLDriver",_FRAGMENT_GUID="GUIDGeneratedOnLastWrite",_ASSOCIATION="association",_ASSOCIATION_NAMESPACE_DATA="associationNamespaceData",_ASSOCIATION_GUID="ID",_ASSOCIATION_DISPLAY_TEXT="displayText",_ASSOCIATION_ASSOCIATED_XOOML_FRAGMENT="associatedXooMLFragment",_ASSOCIATION_ASSOCIATED_XOOML_DRIVER="associatedXooMLDriver",_ASSOCIATION_ASSOCIATED_ITEM="associatedItem",_ASSOCIATION_LOCAL_ITEM_NAME="localItem",_XML_XSI_URI="http://www.w3.org/2001/XMLSchema-instance",_DEFAULT_VALUE_FOR_ADD_ATTRIBUTE="",_CONSTRUCTOR_CASE_1_OPTIONS={xooMLFragmentString:!0},_CONSTRUCTOR_CASE_2_OPTIONS={associations:!0,xooMLUtilityURI:!0,itemUtilityURI:!0,syncUtilityURI:!0,groupingItemURI:!0};return self=FragmentEditor.prototype,self.updateETag=function(){var GUID,self=this;return GUID=XooMLUtil.generateGUID(),self._document.getElementsByTagName(_FRAGMENT)[0].getAttribute(_FRAGMENT_GUID),GUID},self.getSchemaVersion=function(){var self=this;return self._getAttribute(_FRAGMENT_SCHEMA_VERSION,_FRAGMENT,null,null)},self.setSchemaVersion=function(schemaVersion){var self=this;self._setAttribute(_FRAGMENT_SCHEMA_VERSION,schemaVersion,_FRAGMENT,null,null)},self.getSchemaLocation=function(){var self=this;return self._getAttribute(_FRAGMENT_SCHEMA_LOCATION,_FRAGMENT,null,null)},self.setSchemaLocation=function(schemaLocation){var self=this;self._setAttribute(_FRAGMENT_SCHEMA_LOCATION,schemaLocation,_FRAGMENT,null,null)},self.getItemDescribed=function(){var self=this;return self._getAttribute(_FRAGMENT_ITEM_DESCRIBED,_FRAGMENT,null,null)},self.setItemDescribed=function(itemDescribed){var self=this;self._setAttribute(_FRAGMENT_ITEM_DESCRIBED,itemDescribed,_FRAGMENT,null,null)},self.getItemDriver=function(){var self=this;return self._getAttribute(_FRAGMENT_ITEM_DRIVER,_FRAGMENT,null,null)},self.setItemDriver=function(itemDriver){var self=this;self._setAttribute(_FRAGMENT_ITEM_DRIVER,itemDriver,_FRAGMENT,null,null)},self.getSyncDriver=function(){var self=this;self._getAttribute(_FRAGMENT_SYNC_DRIVER,_FRAGMENT,null,null)},self.setSyncDriver=function(syncDriver){var self=this;self._setAttribute(_FRAGMENT_SYNC_DRIVER,syncDriver,_FRAGMENT,null,null)},self.getXooMLDriver=function(){var self=this;return self._getAttribute(_FRAGMENT_XOOML_DRIVER,_FRAGMENT,null,null)},self.setXooMLDriver=function(xooMlDriver){var self=this;self._setAttribute(_FRAGMENT_XOOML_DRIVER,xooMlDriver,_FRAGMENT,null,null)},self.getGUIDGeneratedOnLastWrite=function(){var self=this;return self._getAttribute(_FRAGMENT_GUID,_FRAGMENT,null,null)},self.listFragmentCommonAttributes=function(){var self=this;return self._listAttributes(_FRAGMENT,null,null)},self.getAssociationDisplayText=function(GUID){var self=this;return self._getAttribute(_ASSOCIATION_DISPLAY_TEXT,_ASSOCIATION,null,GUID)},self.setAssociationDisplayText=function(GUID,displayName){var self=this;self._setAttribute(_ASSOCIATION_DISPLAY_TEXT,displayName,_ASSOCIATION_GUID,null,GUID)},self.getAssociationAssociatedXooMLFragment=function(GUID){var self=this;return self._getAttribute(_ASSOCIATION_ASSOCIATED_XOOML_FRAGMENT,_ASSOCIATION,null,GUID)},self.setAssociationAssociatedXooMLFragment=function(GUID,associatedXooMLFragment){var self=this;self._setAttribute(_ASSOCIATION_ASSOCIATED_XOOML_FRAGMENT,associatedXooMLFragment,_ASSOCIATION_GUID,null,GUID)},self.getAssociationXooMLDriver=function(GUID){var self=this;return self._getAttribute(_ASSOCIATION_ASSOCIATED_XOOML_DRIVER,_ASSOCIATION,null,GUID)},self.setAssociationXooMLDriver=function(GUID,xooMLDriver){var self=this;self._setAttribute(_ASSOCIATION_ASSOCIATED_XOOML_DRIVER,xooMLDriver,_ASSOCIATION_GUID,null,GUID)},self.getAssociationLocalItemName=function(GUID){var self=this;return self._getAttribute(_ASSOCIATION_LOCAL_ITEM_NAME,_ASSOCIATION,null,GUID)},self.setAssociationLocalItem=function(GUID,localItem){var self=this;self._setAttribute(_ASSOCIATION_LOCAL_ITEM_NAME,localItem,_ASSOCIATION_GUID,null,GUID)},self.getAssociationAssociatedItem=function(GUID){var self=this;return self._getAttribute(_ASSOCIATION_ASSOCIATED_ITEM,_ASSOCIATION,null,GUID)},self.setAssociationAssociatedItem=function(GUID,associatedItem){var self=this;self._setAttribute(_ASSOCIATION_ASSOCIATED_ITEM,associatedItem,_ASSOCIATION_GUID,null,GUID)},self.listAssociationCommonAttributes=function(GUID){var self=this;return self._listAttributes(_ASSOCIATION,null,GUID)},self.getFragmentNamespaceAttribute=function(attributeName,namespaceURI){var self=this;return self._getAttribute(attributeName,_FRAGMENT_NAMESPACE_DATA,namespaceURI,null)},self.addFragmentNamespaceAttribute=function(attributeName,namespaceURI){var self=this;self._addAttribute(attributeName,_FRAGMENT_NAMESPACE_DATA,namespaceURI,null)},self.removeFragmentNamespaceAttribute=function(attributeName,namespaceURI){var self=this;self._removeAttribute(attributeName,_FRAGMENT_NAMESPACE_DATA,namespaceURI,null)},self.hasFragmentNamespace=function(namespaceURI){var self=this;return self._hasNamespace(null,namespaceURI)},self.setFragmentNamespaceAttribute=function(attributeName,attributeValue,namespaceURI){var self=this;self._setAttribute(attributeName,attributeValue,_FRAGMENT_NAMESPACE_DATA,namespaceURI,null)},self.listFragmentNamespaceAttributes=function(namespaceURI){var self=this;self._listAttributes(_FRAGMENT_NAMESPACE_DATA,namespaceURI,null)},self.getFragmentNamespaceData=function(namespaceURI){var self=this;return self._getNamespaceData(_FRAGMENT,namespaceURI,null)},self.setFragmentNamespaceData=function(data,namespaceURI){var self=this;self._setNamespaceData(_FRAGMENT,namespaceURI,null,data)},self.createAssociation=function(options){if(!options)return XooMLExceptions.nullArgument;if(!XooMLUtil.isObject(options))return XooMLExceptions.invalidType;var GUID,isLinkNonGrouping,isSimple,isLinkGrouping,isCreate,self=this;return self._updateFragment(self._document),GUID=XooMLUtil.generateGUID(),isSimple=XooMLUtil.hasOptions(XooMLConfig.createAssociationSimple,options),isLinkNonGrouping=XooMLUtil.hasOptions(XooMLConfig.createAssociationLinkNonGrouping,options),isLinkGrouping=XooMLUtil.hasOptions(XooMLConfig.createAssociationLinkGrouping,options),isCreate=XooMLUtil.hasOptions(XooMLConfig.createAssociationCreate,options),isSimple?self._createAssociation(GUID,null,options.displayText,null,null,null):isLinkNonGrouping?self._createAssociationLinkNonGrouping(GUID,options):isLinkGrouping?self._createAssociationLinkGrouping(GUID,options):isCreate?self._createAssociationCreate(GUID,options):XooMLExceptions.missingParameter},self.deleteAssociation=function(GUID){if(!GUID)return XooMLExceptions.nullArgument;if(!XooMLUtil.isGUID(GUID))return XooMLExceptions.invalidType;var association,associations,i,self=this;for(associations=self._document.getElementsByTagName(_ASSOCIATION),i=0;i<associations.length;i+=1)association=associations[i],association.getAttribute(_ASSOCIATION_GUID)===GUID&&association.parentNode.removeChild(association);return XooMLExceptions.invalidArgument},self.listAssociations=function(){var associations,associationNodes,associationNode,i,GUID,self=this;for(associations=[],associationNodes=self._document.getElementsByTagName(_ASSOCIATION),i=0;i<associationNodes.length;i+=1)associationNode=associationNodes[i],GUID=associationNode.getAttribute(_ASSOCIATION_GUID),associations.push(GUID);return associations},self.getAssociationNamespaceAttribute=function(attributeName,GUID,namespaceURI){var self=this;return self._getAttribute(attributeName,_ASSOCIATION_NAMESPACE_DATA,namespaceURI,GUID)},self.addAssociationNamespaceAttribute=function(attributeName,GUID,namespaceURI){var self=this;self._addAttribute(attributeName,_ASSOCIATION_NAMESPACE_DATA,namespaceURI,GUID)},self.removeAssociationNamespaceAttribute=function(attributeName,GUID,namespaceURI){var self=this;self._removeAttribute(attributeName,_ASSOCIATION_NAMESPACE_DATA,namespaceURI,GUID)},self.setAssociationNamespaceAttribute=function(attributeName,attributeValue,GUID,namespaceURI){var self=this;self._setAttribute(attributeName,attributeValue,_ASSOCIATION_NAMESPACE_DATA,namespaceURI,GUID)},self.hasAssociationNamespace=function(GUID,namespaceURI){var self=this;return self._hasNamespace(GUID,namespaceURI)},self.listAssociationNamespaceAttributes=function(GUID,namespaceURI){var self=this;return self._listAttributes(_ASSOCIATION_NAMESPACE_DATA,namespaceURI,GUID)},self.getAssociationNamespaceData=function(GUID,namespaceURI){var self=this;return self._getNamespaceData(_ASSOCIATION_NAMESPACE_DATA,namespaceURI,GUID)},self.setAssociationNamespaceData=function(data,GUID,namespaceURI){var self=this;self._setNamespaceData(_ASSOCIATION_NAMESPACE_DATA,namespaceURI,GUID,data)},self.toString=function(){var tmp,self=this;return tmp=document.createElement("div"),tmp.appendChild(self._document.firstChild.cloneNode(!0)),tmp.innerHTML},self._parseXML=function(xml){var parser,xmlDoc;return window.DOMParser?(parser=new DOMParser,xmlDoc=parser.parseFromString(xml,"text/xml")):(xmlDoc=new ActiveXObject("Microsoft.XMLDOM"),xmlDoc.async=!1,xmlDoc.loadXML(xml)),xmlDoc},self._createXooMLFragment=function(associations,xooMLDriverURI,itemDriverURI,syncDriverURI){var fragment,document,i,association,GUID,associatedXooMLFragment,self=this;for(document=self._parseXML("<"+_FRAGMENT+"></"+_FRAGMENT+">"),fragment=document.firstChild,fragment.setAttribute("xmlns",XooMLConfig.schemaLocation),fragment.setAttribute("xmlns:xsi",_XML_XSI_URI),fragment.setAttribute(_FRAGMENT_ITEM_DRIVER,itemDriverURI),fragment.setAttribute(_FRAGMENT_XOOML_DRIVER,xooMLDriverURI),fragment.setAttribute(_FRAGMENT_SYNC_DRIVER,syncDriverURI),fragment.setAttribute(_FRAGMENT_ITEM_DESCRIBED,_ITEM_DESCRIBED),fragment.setAttribute(_FRAGMENT_SCHEMA_LOCATION,XooMLConfig.schemaLocation),fragment.setAttribute(_FRAGMENT_SCHEMA_VERSION,XooMLConfig.schemaVersion),fragment.setAttribute(_FRAGMENT_GUID,XooMLUtil.generateGUID()),i=0;i<associations.length;i+=1)association=associations[i],GUID=XooMLUtil.generateGUID(),associatedXooMLFragment=association.getIsGroupingItem()?PathDriver.joinPath(association.getDisplayText(),XooMLConfig.xooMLFragmentFileName):null,self._createAssociation(GUID,associatedXooMLFragment,association.getDisplayText(),association.getDisplayText(),association.getDisplayText(),fragment);return document},self._createAssociation=function(GUID,associationXooMLFragment,displayText,associatedItem,localItem,fragment){var association,parent,self=this;parent=fragment||self._document.firstChild,localItem=localItem||"",associatedItem=associatedItem||"",associationXooMLFragment=associationXooMLFragment||"",association=self._parseXML("<"+_ASSOCIATION+"/>").firstChild,association.setAttribute(_ASSOCIATION_GUID,GUID),association.setAttribute(_ASSOCIATION_ASSOCIATED_ITEM,associatedItem),association.setAttribute(_ASSOCIATION_DISPLAY_TEXT,displayText),association.setAttribute(_ASSOCIATION_LOCAL_ITEM_NAME,localItem),association.setAttribute(_ASSOCIATION_ASSOCIATED_XOOML_FRAGMENT,associationXooMLFragment),association.setAttribute(_ASSOCIATION_ASSOCIATED_XOOML_DRIVER,""),parent.appendChild(association.cloneNode(!0))},self._createAssociationLinkNonGrouping=function(GUID,options){var self=this;return options.localItemRequested?XooMLExceptions.notImplemented:self._createAssociation(GUID,null,options.displayText,options.itemURI,null,null)},self._createAssociationLinkGrouping=function(){return XooMLExceptions.notImplemented},self._createAssociationCreate=function(GUID,options){var self=this;options.isGroupingItem?self._createAssociation(GUID,null,options.displayText,options.itemName,options.itemName,null):self._createAssociation(GUID,null,options.displayText,options.itemName,options.itemName,null)},self._updateFragment=function(fragment){return fragment.getElementsByTagName(_FRAGMENT)[0].getAttribute(_FRAGMENT_GUID)},self._getOrCreateElement=function(elementName,namespaceURI,GUID){if(!elementName)return XooMLExceptions.nullArgument;if(GUID&&!XooMLUtil.isGUID(GUID)||namespaceURI&&!XooMLUtil.isString(namespaceURI)||!XooMLUtil.isString(elementName))return XooMLExceptions.invalidType;var self=this;return null!==GUID?self._getAssociation(self._document,GUID,namespaceURI,!0):self._getFragment(self._document,namespaceURI,!0)},self._getFragment=function(documentNode,namespaceURI,createIfNotExist){var fragmentNamespaceDataNodes,fragmentNamespaceDataNode,i;if(!namespaceURI)return documentNode.firstChild;for(createIfNotExist=createIfNotExist||!0,fragmentNamespaceDataNodes=documentNode.getElementsByTagName(_FRAGMENT_NAMESPACE_DATA),i=0;i<fragmentNamespaceDataNodes.length;i+=1)if(fragmentNamespaceDataNode=fragmentNamespaceDataNodes[i],namespaceURI===fragmentNamespaceDataNode.getAttribute(_NAMESPACE_ATTRIBUTE))return fragmentNamespaceDataNode;return createIfNotExist?(fragmentNamespaceDataNode=documentNode.createElement(_FRAGMENT_NAMESPACE_DATA),fragmentNamespaceDataNode.setAttribute(_NAMESPACE_ATTRIBUTE,namespaceURI),documentNode.getElementsByTagName(_FRAGMENT)[0].appendChild(fragmentNamespaceDataNode),fragmentNamespaceDataNode):null},self._getAssociation=function(documentNode,GUID,namespaceURI,createIfNotExist){var childNodes,childNode,namespaceNodes,namespaceNode,i,j,self=this;for(createIfNotExist=createIfNotExist||!0,childNodes=documentNode.getElementsByTagName(_ASSOCIATION),i=0;i<childNodes.length;i+=1)if(childNode=childNodes[i],childNode.getAttribute(_ASSOCIATION_GUID)===GUID){if(!namespaceURI)return childNode;for(namespaceNodes=documentNode.getElementsByTagName(_ASSOCIATION_NAMESPACE_DATA),j=0;j<namespaceNodes.length;j+=1)if(namespaceNode=namespaceNodes[j],namespaceNode.getAttribute(_NAMESPACE_ATTRIBUTE)===namespaceURI&&namespaceNode.parentNode.getAttribute(_ASSOCIATION_GUID)==GUID)return namespaceNode;return createIfNotExist?self._createNewNamespaceData(documentNode,childNode,_ASSOCIATION_NAMESPACE_DATA,namespaceURI):null}return createIfNotExist?self._createNewAssociation(documentNode,GUID,namespaceURI):null},self._createNewNamespaceData=function(documentNode,commonNode,namespaceElementName,namespaceURI){var namespaceDataNode;return namespaceDataNode=documentNode.createElement(namespaceElementName),namespaceDataNode.setAttribute(_NAMESPACE_ATTRIBUTE,namespaceURI),commonNode.appendChild(namespaceDataNode),namespaceDataNode},self._createNewAssociation=function(documentNode,GUID,namespaceURI){var association,associationNamespaceData,self=this;return association=documentNode.createElement(_ASSOCIATION),association.setAttribute(_ASSOCIATION_GUID,GUID),namespaceURI&&(associationNamespaceData=self._createNewNamespaceData(documentNode,association,_ASSOCIATION_NAMESPACE_DATA,namespaceURI)),documentNode.getElementsByTagName(_FRAGMENT)[0].appendChild(association),namespaceURI?associationNamespaceData:association},self._getAttribute=function(attributeName,elementName,namespaceURI,GUID){var self=this;self._retrieveAttribute(attributeName,elementName,namespaceURI,GUID,function(error,element){if(error)throw error;return element.getAttribute(attributeName)})},self._setAttribute=function(attributeName,attributeValue,elementName,namespaceURI,GUID){var self=this;self._retrieveAttribute(attributeName,elementName,namespaceURI,GUID,function(error,element){if(error)throw error;element.setAttribute(attributeName,attributeValue),self._updateFragment(self._document)})},self._addAttribute=function(attributeName,elementName,namespaceURI,GUID){var self=this;self._retrieveAttribute(attributeName,elementName,namespaceURI,GUID,function(error,element){if(error)throw error;return element.getAttribute(attributeName)?XooMLExceptions.invalidState:(element.setAttribute(attributeName,_DEFAULT_VALUE_FOR_ADD_ATTRIBUTE),void self._updateFragment(self._document))})},self._removeAttribute=function(attributeName,elementName,namespaceURI,GUID){var self=this;self._retrieveAttribute(attributeName,elementName,namespaceURI,GUID,function(error,element){if(error)throw error;return element.getAttribute(attributeName)?(element.removeAttribute(attributeName),void self._updateFragment(self._document)):XooMLExceptions.invalidState})},self._retrieveAttribute=function(attributeName,elementName,namespaceURI,GUID){if(!attributeName)return XooMLExceptions.nullArgument;if(!XooMLUtil.isString(attributeName))return XooMLExceptions.invalidType;var element,self=this;return element=self._getOrCreateElement(elementName,namespaceURI,GUID)},self._listAttributes=function(elementName,namespaceURI,GUID){var element,attributes,i,attrib,self=this;for(element=self._getOrCreateElement(elementName,namespaceURI,GUID),attributes=[],i=0;i<element.attributes.length;i+=1)attrib=element.attributes[i],attributes.push(attrib.name);return attributes},self._getNamespaceData=function(elementName,namespaceURI,GUID){var element,self=this;return element=self._getOrCreateElement(elementName,namespaceURI,GUID),element.innerHTML},self._setNamespaceData=function(elementName,namespaceURI,GUID,data){if(!data)return XooMLExceptions.nullArgument;if(!XooMLUtil.isString(data))return XooMLExceptions.invalidType;var element,self=this;element=self._getOrCreateElement(elementName,namespaceURI,GUID),element.innerHTML=data},self._hasNamespace=function(GUID,namespaceURI){if(!namespaceURI)return XooMLExceptions.nullArgument;if(GUID&&!XooMLUtil.isGUID(GUID))return XooMLExceptions.invalidType;var element,self=this;return element=GUID?self._getAssociation(self._document,GUID,namespaceURI,!1):self._getFragment(self._document,namespaceURI,!1),null!==element},FragmentEditor}),define("ItemDriver.js",["./XooMLExceptions.js","./XooMLConfig.js","./XooMLUtil.js","./XooMLAssociation.js"],function(XooMLExceptions,XooMLConfig,XooMLUtil,XooMLAssociation){"use strict";function ItemDriver(options,callback){if(XooMLUtil.checkCallback(callback),!XooMLUtil.isObject(options))return callback(XooMLExceptions.invalidType);if(!XooMLUtil.isFunction(callback))return callback(XooMLExceptions.invalidType);if(!XooMLUtil.hasOptions(_CONSTRUCTOR__OPTIONS,options))return callback(XooMLExceptions.missingParameter);var self=this;self._dropboxClient=options.dropboxClient,self._checkDropboxAuthenticated(self._dropboxClient)?callback(!1,self):self._dropboxClient.authenticate(function(error){return error?callback(XooMLExceptions.itemUException,null):callback(!1,self)})}var self,_CONSTRUCTOR__OPTIONS={driverURI:!0,dropboxClient:!0},_DIRECTORY_STAT="inode/directory";self=ItemDriver.prototype,self.moveGroupingItem=function(fromPath,newPath,callback){var self=this;self._dropboxClient.move(fromPath,newPath,function(error){return callback(error?error:!1)})},self.isGroupingItem=function(path,callback){var self=this;self._dropboxClient.stat(path,function(error,stat){return error?self._showDropboxError(error,callback):callback(!1,stat.mimeType===_DIRECTORY_STAT)})},self.createGroupingItem=function(path,callback){var self=this;self._dropboxClient.mkdir(path,function(error,stat){return error?self._showDropboxError(error,callback):callback(!1,stat)})},self.createNonGroupingItem=function(path,file,callback){var self=this;self._dropboxClient.writeFile(path,file,function(error,stat){return error?self._showDropboxError(error,callback):callback(!1,stat)})},self.deleteGroupingItem=function(path,callback){var self=this;self._dropboxClient.remove(path,function(error,stat){return error?self._showDropboxError(error,callback):callback(!1,stat)})},self.deleteNonGroupingItem=function(path,callback){var self=this;self._dropboxClient.remove(path,function(error,stat){return error?self._showDropboxError(error,callback):callback(!1,stat)})},self.copyItem=function(fromPath,toPath,callback){var self=this;self._dropboxClient.copy(fromPath,toPath,function(error){return error?self._showDropboxError(error,callback):callback(!1)})},self.moveItem=function(fromPath,toPath,callback){var self=this;self._dropboxClient.move(fromPath,toPath,function(error){return error?self._showDropboxError(error,callback):callback(!1)})},self.getURL=function(path,callback){var self=this;self._dropboxClient.makeUrl(path,null,function(error,publicURL){return error?self._showDropboxError(error,callback):callback(!1,publicURL.url)})},self.listItems=function(path,callback){var self=this;self._dropboxClient.readdir(path,function(error,list,stat,listStat){if(error)return self._showDropboxError(error,callback);var i,output;for(output=[],i=0;i<listStat.length;i+=1)listStat[i].name!==XooMLConfig.xooMLFragmentFileName&&output.push(new XooMLAssociation(listStat[i].mimeType===_DIRECTORY_STAT,listStat[i].name));return callback(!1,output)})},self.checkExisted=function(path,callback){var result,self=this;self._dropboxClient.stat(path,function(error,stat){return error?self._showDropboxError(error,callback):(result=!(null!==error&&404===error.status)||null===error&&stat.isRemoved,callback(!1,result))})},self.writeItem=function(uri,content,callback){var self=this;return self._dropboxClient.writeFile(uri,content,function(error,stat){return error?self._showDropboxError(error,callback):void callback(!1,stat)}),self.readItem=function(uri,callback){var self=this;self._dropboxClient.readFile(uri,function(error,content){return error?self._showDropboxError(error,callback):void callback(!1,content)})},self._showDropboxError=function(error,callback){return callback(error.status)},self._checkDropboxAuthenticated=function(dropboxClient){return 4===dropboxClient.authState},ItemDriver}}),define("XooMLDriver.js",["./XooMLExceptions.js","./XooMLConfig.js","./XooMLUtil.js"],function(XooMLExceptions,XooMLConfig,XooMLUtil){"use strict";function XooMLDriver(options,callback){if(XooMLUtil.checkCallback(callback),!XooMLUtil.hasOptions(_CONSTRUCTOR_OPTIONS,options))return callback(XooMLExceptions.missingParameter);if(!XooMLUtil.isObject(options))return callback(XooMLExceptions.invalidType);var self=this;return self._dropboxClient=options.dropboxClient,self._checkDropboxAuthenticated(self._dropboxClient)?callback(!1,self):void self._dropboxClient.authenticate(function(error){return error?callback(XooMLExceptions.xooMLUException,null):callback(!1,self)})}var self,_CONSTRUCTOR_OPTIONS={driverURI:!0,dropboxClient:!0};return self=XooMLDriver.prototype,self.getXooMLFragment=function(uri,callback){var self=this;self._dropboxClient.readFile(uri,function(error,content){return error?self._showDropboxError(error,callback):void callback(!1,content)})},self.setXooMLFragment=function(uri,fragment,callback){var self=this;self._dropboxClient.writeFile(uri,fragment,function(error,stat){return error?self._showDropboxError(error,callback):void callback(!1,stat)})},self.checkExisted=function(uri,callback){var result,self=this;self._dropboxClient.stat(uri,function(error,stat){return error?self._showDropboxError(error,callback):(result=null!==error&&404===error.status||null===error&&stat.isRemoved===!0?!1:!0,void callback(!1,result))})},self._showDropboxError=function(error,callback){return callback(error.status)},self._checkDropboxAuthenticated=function(dropboxClient){return 4===dropboxClient.authState},XooMLDriver}),define("SyncDriver.js",["./XooMLExceptions.js","./XooMLConfig.js","./XooMLUtil.js"],function(){"use strict";function SyncDriver(itemMirror){var self=this;self._itemMirror=itemMirror,self._fragmentEditor=itemMirror._fragmentEditor,self._itemDriver=itemMirror._itemDriver,self._xooMLDriver=itemMirror._xooMLDriver}var self;return self=SyncDriver.prototype,self.sync=function(callback){var self=this;self._itemDriver.listItems(self._itemMirror._groupingItemURI,function(error,associations){if(error)return callback(error);var realAssociations=associations.map(function(assoc){return{name:assoc.getDisplayText(),groupingItem:assoc.getIsGroupingItem()}}),memoryAssociations=self._itemMirror.listAssociations().map(function(guid){return{guid:guid,name:self._itemMirror.getAssociationLocalItemName(guid)}}).filter(function(assoc){return null!==assoc.name}),nameCompare=function(a,b){return a.name>b.name?1:a.name<b.name?-1:0};realAssociations.sort(nameCompare),memoryAssociations.sort(nameCompare);var search,realNames=realAssociations.map(function(assoc){return assoc.name}),memoryNames=memoryAssociations.map(function(assoc){return assoc.name}),memoryIdx=0,sychronized=!0;realNames.forEach(function(name,realIdx){search=memoryNames.indexOf(name,memoryIdx),-1===search?(sychronized=!1,self._fragmentEditor.createAssociation({displayText:name,itemName:name,isGroupingItem:realAssociations[realIdx].isGroupingItem})):(memoryAssociations.slice(memoryIdx,search).forEach(function(assoc){sychronized=!1,self._fragmentEditor.deleteAssociation(assoc.guid)}),memoryIdx=search)}),memoryAssociations.slice(memoryIdx,memoryNames.length).forEach(function(assoc){sychronized=!1,self._fragmentEditor.deleteAssociation(assoc.guid)}),sychronized||self._itemMirror._saveFragment(callback)})},SyncDriver}),define("ItemMirror",["./XooMLExceptions.js","./XooMLConfig.js","./XooMLUtil.js","./PathDriver.js","./FragmentEditor.js","./ItemDriver.js","./XooMLDriver.js","./SyncDriver.js"],function(XooMLExceptions,XooMLConfig,XooMLUtil,PathDriver,ItemDriver,XooMLDriver,FragmentEditor,SyncDriver){"use strict";function ItemMirror(options,callback){if(XooMLUtil.checkCallback(callback),!options)return callback(XooMLExceptions.nullArgument);if(!XooMLUtil.isObject(options))return callback(XooMLExceptions.invalidType);if(!XooMLUtil.hasOptions(_CONSTRUCTOR_CASE_2_AND_3_OPTIONS,options)&&!XooMLUtil.hasOptions(_CONSTRUCTOR_CASE_1_OPTIONS,options))return callback(XooMLExceptions.missingParameter);var xooMLFragmentURI,self=this;self._xooMLDriver=null,self._itemDriver=null,self._syncDriver=null,self._fragmentEditor=null,self._parent=options.parent,self._groupingItemURI=PathDriver.formatPath(options.groupingItemURI),self._newItemMirrorOptions=options,xooMLFragmentURI=PathDriver.joinPath(self._groupingItemURI,XooMLConfig.xooMLFragmentFileName),new XooMLDriver(options.xooMLDriver,function(error,xooMLU){self._xooMLDriver=xooMLU,self._getItemU(xooMLFragmentURI,options,function(error){return error?callback(error):void self._save(function(error){return error?callback(error):(self._newItemMirrorOptions.hasOwnProperty("syncDriver")||(self._newItemMirrorOptions.syncDriver={utilityURI:"MirrorSyncUtility"}),self._newItemMirrorOptions.groupingItemURI=null,callback(!1,self))
})})})}var self,_CONSTRUCTOR_CASE_1_OPTIONS={groupingItemURI:!0,xooMLDriver:!0,itemDriver:!0,parent:!1},_CONSTRUCTOR_CASE_2_AND_3_OPTIONS={groupingItemURI:!0,xooMLDriver:!0,itemDriver:!0,syncDriver:!0,readIfExists:!0,parent:!1},_UPGRADE_ASSOCIATION_OPTIONS={GUID:!0,localItemURI:!1};return self=ItemMirror.prototype,self.getDisplayName=function(callback){var displayName,self=this;return PathDriver.isRoot(self._groupingItemURI)?displayName="":(displayName=PathDriver.formatPath(self._groupingItemURI),displayName=PathDriver.splitPath(displayName),displayName=displayName[displayName.length-1]),callback(!1,displayName)},self.getSchemaVersion=function(){var self=this;return self._fragmentEditor.getSchemaVersion()},self.getSchemaLocation=function(){var self=this;return self._fragmentEditor.getSchemaLocation()},self.getURIforItemDescribed=function(){var self=this;return self._fragmentEditor.getItemDescribed()},self.getItemDriver=function(){var self=this;return self._fragmentEditor.getItemDriver()},self.getSyncDriver=function(){var self=this;return self._fragmentEditor.getSyncDriver()},self.getXooMLDriver=function(){var self=this;return self._fragmentEditor.getXooMLDriver()},self.getAssociationDisplayText=function(GUID){var self=this;return self._fragmentEditor.getAssociationDisplayText(GUID)},self.setAssociationDisplayText=function(GUID,displayText){var self=this;self._fragmentEditor.setAssociationDisplayText(GUID,displayText)},self.getAssociationLocalItemName=function(GUID){var self=this;return self._fragmentEditor.getAssociationLocalItemName(GUID)},self.getAssociatedItemOfAssociation=function(GUID){var self=this;return self._fragmentEditor.getAssociatedItemOfAssociation(GUID)},self.getFragmentNamespaceAttribute=function(attributeName,namespaceURI){var self=this;return self._fragmentEditor.getFragmentNamespaceAttribute(attributeName,namespaceURI)},self.addFragmentNamespaceAttribute=function(attributeName,namespaceURI){var self=this;self._fragmentEditor.addFragmentNamespaceAttribute(attributeName,namespaceURI)},self.removeFragmentNamespaceAttribute=function(attributeName,namespaceURI){var self=this;self._fragmentEditor.removeFragmentNamespaceAttribute(attributeName,namespaceURI)},self.hasFragmentNamespace=function(namespaceURI){var self=this;return self._fragmentEditor.hasFragmentNamespace(namespaceURI)},self.setFragmentNamespaceAttribute=function(attributeName,attributeValue,namespaceURI){var self=this;self._fragmentEditor.setFragmentNamespaceAttribute(attributeName,attributeValue,namespaceURI)},self.listFragmentNamespaceAttributes=function(namespaceURI){var self=this;return self._fragmentEditor.listFragmentNamespaceAttributes(namespaceURI)},self.getFragmentNamespaceData=function(namespaceURI){var self=this;return self._fragmentEditor.getFragmentNamespaceData(namespaceURI)},self.setFragmentNamespaceData=function(data,namespaceURI){var self=this;self._fragmentEditor.setFragmentNamespaceData(data,namespaceURI)},self.createItemMirrorForAssociatedGroupingItem=function(GUID,callback){var self=this;self.isAssociatedItemGrouping(GUID,function(error,isGrouping){return error?callback(error):isGrouping?void self._fragmentEditor.getAssociatedItemOfAssociation(GUID,function(error,associatedItem){if(error)return callback(error);var associatedXooMLFragment;associatedXooMLFragment=PathDriver.joinPath(associatedItem,XooMLConfig.xooMLFragmentFileName),self._fragmentEditor.setAssociationAssociatedXooMLFragment(GUID,associatedXooMLFragment,function(error){if(error)return callback(error);var path,itemMirrorOptions;path=PathDriver.joinPath(self._groupingItemURI,associatedItem),itemMirrorOptions=self._newItemMirrorOptions,itemMirrorOptions.groupingItemURI=path,itemMirrorOptions.readIfExists=!0,itemMirrorOptions.parent=self,new ItemMirror(itemMirrorOptions,function(error,itemMirror){return error?callback(error):void self._sync(function(error){if(error)throw error;return callback(!1,itemMirror)})})})}):callback(!1,null)})},self.createAssociation=function(options,callback){var isSimple,isLinkNonGrouping,isLinkGrouping,isCreate,self=this;if(!XooMLUtil.isFunction(callback))throw XooMLExceptions.invalidType;return XooMLUtil.isObject(options)?(isSimple=XooMLUtil.hasOptions(XooMLConfig.createAssociationSimple,options),isLinkNonGrouping=XooMLUtil.hasOptions(XooMLConfig.createAssociationLinkNonGrouping,options),isLinkGrouping=XooMLUtil.hasOptions(XooMLConfig.createAssociationLinkGrouping,options),isCreate=XooMLUtil.hasOptions(XooMLConfig.createAssociationCreate,options),void self._fragmentEditor.createAssociation(options,function(error,GUID){return error?callback(error):isSimple?void self._createAssociationSimple(GUID,options,callback):isLinkNonGrouping?self._createAssociationLinkNonGrouping(GUID,options,callback):isLinkGrouping?self._createAssociationLinkGrouping(GUID,options,callback):isCreate?self._createAssociationCreate(GUID,options,callback):callback(XooMLExceptions.missingParameter)})):callback(XooMLExceptions.invalidType)},self.copyAssociation=function(GUID,ItemMirror,callback){var self=this;return XooMLUtil.checkCallback(callback),GUID?XooMLUtil.isGUID(GUID)?void self.getAssociationLocalItemName(GUID,function(error,localItem){if(error)return callback(error);if(!localItem){var options={};return self.getAssociationDisplayText(GUID,function(error,displayText){return error?callback(error):(options.displayText=displayText,void self.getAssociatedItemOfAssociation(GUID,function(error,associatedItem){return error?callback(error):void(options.itemURI=associatedItem)}))}),ItemMirror.createAssociation(options,function(error){return error?callback(error):void 0}),ItemMirror._save(callback)}self._handleDataWrapperCopyAssociation(GUID,localItem,ItemMirror,error,callback)}):callback(XooMLExceptions.invalidType):callback(XooMLExceptions.nullArgument)},self.moveAssociation=function(GUID,ItemMirror,callback){var self=this;return XooMLUtil.checkCallback(callback),GUID?XooMLUtil.isGUID(GUID)?void self.getAssociationLocalItemName(GUID,function(error,localItem){if(error)return callback(error);if(!localItem){var options={};self.getAssociationDisplayText(GUID,function(error,displayText){return error?callback(error):(options.displayText=displayText,void self.getAssociatedItemOfAssociation(GUID,function(error,associatedItem){return error?callback(error):void(options.itemURI=associatedItem)}))}),ItemMirror.createAssociation(options,function(error){return error?callback(error):(self._fragmentEditor.deleteAssociation(GUID,function(error){return error?callback(error):self._save(callback)}),ItemMirror._save(callback))})}self._handleDataWrapperMoveAssociation(GUID,localItem,ItemMirror,error,callback)}):callback(XooMLExceptions.invalidType):callback(XooMLExceptions.nullArgument)},self.deleteAssociation=function(GUID,callback){var self=this;return XooMLUtil.checkCallback(callback),GUID?XooMLUtil.isGUID(GUID)?void self.getAssociationLocalItemName(GUID,function(error,localItem){return error?callback(error):void self._fragmentEditor.deleteAssociation(GUID,function(error){return error?callback(error):localItem?void self._handleDataWrapperDeleteAssociation(GUID,localItem,error,callback):self._save(callback)})}):callback(XooMLExceptions.invalidType):callback(XooMLExceptions.nullArgument)},self.upgradeAssociation=function(options,callback){var self=this;return XooMLUtil.checkCallback(callback),XooMLUtil.hasOptions(_UPGRADE_ASSOCIATION_OPTIONS,options)?options.hasOwnProperty("localItemURI")&&!XooMLUtil.isString(options.localItemURI)||!XooMLUtil.isGUID(options.GUID)?callback(XooMLExceptions.invalidType):void(options.hasOwnProperty("localItemURI")?self._setSubGroupingItemURIFromDisplayText(options.GUID,options.localItemURI,callback):self.getAssociationDisplayText(options.GUID,function(error,displayText){return error?callback(error):void self._setSubGroupingItemURIFromDisplayText(options.GUID,displayText,callback)})):callback(XooMLExceptions.missingParameter)},self.renameLocalItemOfAssociation=function(GUID,newName,callback){var self=this;return XooMLUtil.checkCallback(callback),GUID?XooMLUtil.isGUID(GUID)?void self.getAssociationLocalItemName(GUID,function(error,localItem){return error?callback(error):localItem?void self._handleDataWrapperRenameAssociation(GUID,localItem,newName,error,callback):callback(error)}):callback(XooMLExceptions.invalidType):callback(XooMLExceptions.nullArgument)},self.isAssociatedItemGrouping=function(GUID){var associatedItem,xooMLFragment,self=this;return associatedItem=self._fragmentEditor.getAssociatedItemOfAssociation(GUID),associatedItem&&""!==associatedItem?(xooMLFragment=self._fragmentEditor.getAssociationAssociatedXooMLFragment(GUID),xooMLFragment&&""!==xooMLFragment&&null!==xooMLFragment?!1:!1):!1},self.isGroupingItem=function(GUID,callback){var self=this;self._fragmentEditor.getAssociationAssociatedXooMLFragment(GUID,function(error,XooMLFragment){return error?callback(error):XooMLFragment&&""!==XooMLFragment&&null!==XooMLFragment?callback(!1,!0):callback(!1,!1)})},self.listAssociations=function(){var self=this;return self._fragmentEditor.listAssociations()},self.getAssociationNamespaceAttribute=function(attributeName,GUID,namespaceURI){var self=this;return self._fragmentEditor.getAssociationNamespaceAttribute(attributeName,GUID,namespaceURI)},self.addAssociationNamespaceAttribute=function(attributeName,GUID,namespaceURI){var self=this;return self._fragmentEditor.addAssociationNamespaceAttribute(attributeName,GUID,namespaceURI)},self.removeAssociationNamespaceAttribute=function(attributeName,GUID,namespaceURI){var self=this;self._fragmentEditor.removeAssociationNamespaceAttribute(attributeName,GUID,namespaceURI)},self.hasAssociationNamespace=function(GUID,namespaceURI){var self=this;return self._fragmentEditor.hasAssociationNamespace(GUID,namespaceURI)},self.setAssociationNamespaceAttribute=function(attributeName,attributeValue,GUID,namespaceURI){var self=this;self._fragmentEditor.setAssociationNamespaceAttribute(attributeName,attributeValue,GUID,namespaceURI)},self.listAssociationNamespaceAttributes=function(GUID,namespaceURI){var self=this;return self._fragmentEditor.listAssociationNamespaceAttributes(GUID,namespaceURI)},self.getAssociationNamespaceData=function(GUID,namespaceURI){var self=this;return self._fragmentEditor.getAssociationNamespaceData(GUID,namespaceURI)},self.setAssociationNamespaceData=function(data,GUID,namespaceURI){var self=this;self._fragmentEditor.setAssociationNamespaceData(data,GUID,namespaceURI)},self._sync=function(callback){var self=this;self._syncDriver.sync(callback)},self._isCurrent=function(callback){var inMemoryGUID,xooMLFragmentURI,self=this;inMemoryGUID=self._getguidgeneratedonlastwrite(),xooMLFragmentURI=PathDriver.joinPath(self._groupingItemURI,XooMLConfig.xooMLFragmentFileName),self._xooMLDriver.getXooMLFragment(xooMLFragmentURI,function(error,content){return error?callback(error):void new FragmentEditor({xooMLFragmentString:content},function(error,tempDataWrapper){callback(!1,inMemoryGUID===tempDataWrapper._getguidgeneratedonlastwrite())})})},self.refresh=function(callback){var xooMLFragmentPath,self=this;self.isCurrent(function(error,isCurrent){if(error)throw error;return isCurrent?callback(!1):(xooMLFragmentPath=PathDriver.joinPath(self._groupingItemURI,XooMLConfig.xooMLFragmentFileName),void self._loadXooMLFragmentString(xooMLFragmentPath,callback))})},self.getItemMirrorFromWhichThisWasCreated=function(){var self=this;return self._parent},self._setSubGroupingItemURIFromDisplayText=function(GUID,displayText,callback){var length,subGroupingItemURI,path,self=this;length=displayText.length<=XooMLConfig.maxFileLength?displayText.length:XooMLConfig.maxFileLength,subGroupingItemURI=displayText.substring(0,length),path=PathDriver.joinPath(self._groupingItemURI,subGroupingItemURI),self._itemDriver.createGroupingItem(path,function(error){return error?callback(error):void self._setAssociationLocalItemAndAssociatedItem(GUID,subGroupingItemURI,callback)})},self._getGUIDGeneratedOnLastWrite=function(){var self=this;return self._fragmentEditor.getGUIDGeneratedOnLastWrite()},self._setAssociationLocalItemAndAssociatedItem=function(GUID,itemURI,callback){var self=this;self._fragmentEditor.setAssociationLocalItem(GUID,itemURI,function(error){return error?callback(error):void self._fragmentEditor.setAssociationAssociatedItem(GUID,itemURI,function(error){return error?callback(error):void self._save(callback)})})},self._save=function(callback){var self=this;self._isCurrent(function(error,isCurrent){return error?callback(error):isCurrent?void self._saveFragment(callback):callback(XooMLExceptions.itemMirrorNotCurrent)})},self._saveFragment=function(callback){var toString,self=this;self._fragmentEditor.updateEtag(),toString=self._fragmentEditor.toString();var xooMLFragmentPath=PathDriver.joinPath(self._groupingItemURI,XooMLConfig.xooMLFragmentFileName);self._xooMLDriver.setXooMLFragment(xooMLFragmentPath,toString,function(error){return error?callback(error):void callback(!1)})},self._getItemU=function(xooMLFragmentURI,options,callback){var self=this;self._itemDriver=new ItemDriver(options.itemDriver,function(error,itemU){return error?callback(error,null):(self._itemDriver=itemU,void(XooMLUtil.hasOptions(_CONSTRUCTOR_CASE_2_AND_3_OPTIONS,options)?options.readIfExists?self._getItemUForFallbackConstructor(xooMLFragmentURI,options,callback):self._getItemUNewXooMLFragment(xooMLFragmentURI,options,callback):XooMLUtil.hasOptions(_CONSTRUCTOR_CASE_1_OPTIONS,options)&&self._loadXooMLFragmentString(xooMLFragmentURI,callback)))})},self._createSyncDriver=function(){var self=this;return new SyncDriver(self)},self._loadXooMLFragmentString=function(uri,callback){var self=this;self._xooMLDriver.getXooMLFragment(uri,function(error,content){return error?callback(error,null):void new FragmentEditor({xooMLFragmentString:content},function(error,fragmentWrapper){return error?callback(error):(self._fragmentEditor=fragmentWrapper,self._syncDriver=self._createSyncDriver(),void self._sync(function(error){if(error)throw error;return callback(!1,self)}))})})},self._getItemList=function(options,callback){var self=this;self._itemDriver.listItems(self._groupingItemURI,function(error,list){return error?callback(error,null):void self._createXooMLFragment(options,list,callback)})},self._createXooMLFragment=function(options,list,callback){var fragmentWrapperOptions,self=this;fragmentWrapperOptions={associations:list,xooMLUtilityURI:options.xooMLDriver.driverURI,itemUtilityURI:options.itemDriver.driverURI,syncUtilityURI:options.syncDriver.driverURI,groupingItemURI:options.groupingItemURI},new FragmentEditor(fragmentWrapperOptions,function(error,fragmentWrapper){return error?callback(error,null):(self._fragmentEditor=fragmentWrapper,self._syncDriver=self._createSyncDriver(),void self._saveFragment(callback))})},self._handleExistingAssociationDelete=function(GUID,item,callback){var path,self=this;path=PathDriver.joinPath(self._groupingItemURI,item),self._itemDriver.isGroupingItem(path,function(error,result){return error?callback(error,null):void(result===!0?self._removeNonGroupingItemThroughAssociation(GUID,item,callback):self._removeGroupingItemThroughAssociation(GUID,item,callback))})},self._handleExistingAssociationCopy=function(GUID,item,ItemMirror,callback){var pathFrom,pathTo,self=this;pathFrom=PathDriver.joinPath(self._groupingItemURI,item),pathTo=PathDriver.joinPath(ItemMirror._groupingItemURI,item),self._itemDriver.copyItem(pathFrom,pathTo,function(error){return error?self._handleSet(error,callback):callback(!1)})},self._handleExistingAssociationMove=function(GUID,item,ItemMirror,callback){var pathFrom,pathTo,self=this;pathFrom=PathDriver.joinPath(self._groupingItemURI,item),pathTo=PathDriver.joinPath(ItemMirror._groupingItemURI,item),self._itemDriver.moveItem(pathFrom,pathTo,function(error){return error?self._handleSet(error,callback):callback(!1)})},self._handleExistingAssociationRename=function(GUID,item1,item2,callback){var pathFrom,pathTo,self=this;pathFrom=PathDriver.joinPath(self._groupingItemURI,item1),pathTo=PathDriver.joinPath(self._groupingItemURI,item2),self._itemDriver.moveItem(pathFrom,pathTo,function(error){return error?self._handleSet(error,callback):callback(!1)})},self._removeNonGroupingItemThroughAssociation=function(GUID,item,callback){var path,self=this;path=PathDriver.joinPath(self._groupingItemURI,item),self._itemDriver.deleteNonGroupingItem(path,function(error){self._handleSet(error,callback)})},self._removeGroupingItemThroughAssociation=function(GUID,item,callback){var path,self=this;path=PathDriver.joinPath(self._groupingItemURI,item),self._itemDriver.deleteGroupingItem(path,function(error){self._handleSet(error,callback)})},self._handleSet=function(error,callback){if(error)return callback(error,null);var self=this;self._save(callback)},self._getItemUForFallbackConstructor=function(xooMLFragmentURI,options,callback){var self=this;self._xooMLDriver.checkExisted(xooMLFragmentURI,function(error,result){result===!0?self._loadXooMLFragmentString(xooMLFragmentURI,callback):self._getItemList(options,callback)})},self._getItemUNewXooMLFragment=function(xooMLFragmentURI,options,callback){var self=this;self._xooMLDriver.checkExisted(xooMLFragmentURI,function(error,result){return result===!0?callback(XooMLExceptions.itemAlreadyExists):void self._getItemList(options,callback)})},self._createAssociationSimple=function(GUID,options,callback){var self=this;return self._save(function(error){return callback(error,GUID)})},self._createAssociationLinkNonGrouping=function(GUID,options,callback){var self=this;return options.localItemRequested?callback(XooMLExceptions.notImplemented):self._save(function(error){return callback(error,GUID)})},self._createAssociationLinkGrouping=function(GUID,options,callback){return!options.localItemRequested,callback(XooMLExceptions.notImplemented)},self._createAssociationCreate=function(GUID,options,callback){var self=this;return options.isGroupingItem?self._createAssociationGroupingItem(GUID,options,callback):self._createAssociationNonGroupingItem(GUID,options,callback)},self._createAssociationGroupingItem=function(GUID,options,callback){var path,self=this;path=PathDriver.joinPath(self._groupingItemURI,options.itemName),self._itemDriver.createGroupingItem(path,function(error,stat){return error||stat.name!==options.itemName?callback(error,null):self._saveAssociationAssociatedXooMLFragment(GUID,options,callback)})},self._saveAssociationAssociatedXooMLFragment=function(GUID,options,callback){var self=this;self._fragmentEditor.setAssociationAssociatedXooMLFragment(GUID,XooMLConfig.xooMLFragmentFileName,function(error){return error?callback(error):void self._save(function(error){callback(error,GUID)})})},self._createAssociationNonGroupingItem=function(GUID,options,callback){var self=this;self._checkExistenceFromItemDescribed(function(error,result){return error?callback(error,null):result?callback(XooMLExceptions.itemUException):void self._createNonGroupingItemFromItemDescribed(GUID,options,callback)})},self._createNonGroupingItemFromItemDescribed=function(GUID,options,callback){var path,self=this;path=PathDriver.joinPath(self._groupingItemURI,options.itemName),self._itemDriver.createNonGroupingItem(path,"",function(error,stat){return error||stat.name===options.itemName?callback(error,null):void self._save(function(error){callback(error,GUID)})})},self._checkExistenceFromItemDescribed=function(itemName,callback){var path,self=this;path=PathDriver.joinPath(self._groupingItemURI,itemName),self._itemDriver.checkExisted(path,function(error,result){return error?callback(error,null):callback(error,result,self._groupingItemURI)})},self._handleDataWrapperDeleteAssociation=function(GUID,localItem,error,callback){var path,self=this;return error?callback(error):(path=PathDriver.joinPath(self._groupingItemURI,localItem),void self._itemDriver.checkExisted(path,function(error,result){return error?callback(error):result===!0?self._handleExistingAssociationDelete(GUID,localItem,callback):callback(XooMLExceptions.invalidState)}))},self._handleDataWrapperCopyAssociation=function(GUID,localItem,ItemMirror,error,callback){var path,self=this;return error?callback(error):(path=PathDriver.joinPath(self._groupingItemURI,localItem),void self._itemDriver.checkExisted(path,function(error,result){return error?callback(error):result===!0?self._handleExistingAssociationCopy(GUID,localItem,ItemMirror,callback):callback(XooMLExceptions.invalidState)}))},self._handleDataWrapperMoveAssociation=function(GUID,localItem,ItemMirror,error,callback){var path,self=this;return error?callback(error):(path=PathDriver.joinPath(self._groupingItemURI,localItem),void self._itemDriver.checkExisted(path,function(error,result){return error?callback(error):result===!0?self._handleExistingAssociationMove(GUID,localItem,ItemMirror,callback):callback(XooMLExceptions.invalidState)}))},self._handleDataWrapperRenameAssociation=function(GUID,localItem,newName,error,callback){var path,self=this;return error?callback(error):(path=PathDriver.joinPath(self._groupingItemURI,localItem),void self._itemDriver.checkExisted(path,function(error,result){return error?callback(error):result===!0?self._handleExistingAssociationRename(GUID,localItem,newName,callback):callback(XooMLExceptions.invalidState)}))},self._isURL=function(URL){return/^http:\/\//.exec(URL)},ItemMirror});
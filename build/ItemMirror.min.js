define("XooMLExceptions.js",[],function(){"use strict";return{notImplemented:"NotImplementedException",missingParameter:"MissingParameterException",nullArgument:"NullArgumentException",invalidType:"InvalidTypeException",invalidState:"InvalidStateArgument",xooMLUException:"XooMLUException",itemUException:"ItemUException",nonUpgradeableAssociationException:"NonUpgradeableAssociationException",invalidArgument:"InvalidOptionsException",itemAlreadyExists:"ItemAlreadyExistsException",itemMirrorNotCurrent:"ItemMirrorNotCurrent"}}),define("XooMLConfig.js",[],function(){"use strict";return{schemaVersion:"0.54",schemaLocation:"http://kftf.ischool.washington.edu/xmlns/xooml",xooMLFragmentFileName:"XooML2.xml",maxFileLength:50,createAssociationSimple:{displayText:!0},createAssociationLinkNonGrouping:{displayText:!0,itemURI:!0,localItemRequested:!1},createAssociationLinkGrouping:{displayText:!0,groupingItemURI:!0,xooMLDriverURI:!0},createAssociationCreate:{displayText:!0,itemName:!0,isGroupingItem:!0}}}),define("XooMLUtil.js",["./XooMLExceptions.js","./XooMLConfig.js"],function(XooMLExceptions){"use strict";var _TYPES={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object","[object Error]":"error"},XooMLUtil={hasOptions:function(checkedOptions,options){if(!checkedOptions||!options)throw XooMLExceptions.nullArgument;if(!XooMLUtil.isObject(checkedOptions)||!XooMLUtil.isObject(options))throw XooMLExceptions.invalidType;var checkedOption,isRequiredOption,missingOptionalParamCount;if(missingOptionalParamCount=0,!(Object.keys(options).length<=Object.keys(checkedOptions).length))return!1;for(checkedOption in checkedOptions)if(checkedOptions.hasOwnProperty(checkedOption)&&(isRequiredOption=checkedOptions[checkedOption],!options.hasOwnProperty(checkedOption))){if(isRequiredOption)return!1;missingOptionalParamCount+=1}return Object.keys(options).length<=Object.keys(checkedOptions).length-missingOptionalParamCount},checkCallback:function(callback){if(!callback)throw XooMLExceptions.nullArgument;if(!XooMLUtil.isFunction(callback))throw XooMLExceptions.invalidType},isGUID:function(GUID){return"string"===XooMLUtil.getType(GUID)?!0:!1},isArray:function(value){return"array"===XooMLUtil.getType(value)},isObject:function(value){return"object"===XooMLUtil.getType(value)},isFunction:function(value){return null!==value},isString:function(value){return"string"===XooMLUtil.getType(value)},isBoolean:function(value){return"boolean"===XooMLUtil.getType(value)},generateGUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0,v="x"==c?r:3&r|8;return v.toString(16)})},getType:function(obj){return null==obj?String(obj):"object"==typeof obj||"function"==typeof obj?_TYPES[obj.toString()]||"object":typeof obj},endsWith:function(string,suffix){return-1!==string.indexOf(suffix,string.length-suffix.length)},clone:function(obj){if(null==obj||"object"!=typeof obj)return obj;if(obj instanceof Date){var copy=new Date;return copy.setTime(obj.getTime()),copy}if(obj instanceof Array){for(var copy=[],i=0,len=obj.length;len>i;i++)copy[i]=XooMLUtil.clone(obj[i]);return copy}if(obj instanceof Object){var copy={};for(var attr in obj)obj.hasOwnProperty(attr)&&(copy[attr]=XooMLUtil.clone(obj[attr]));return copy}throw XooMLExceptions.invalidType}};return XooMLUtil}),define("PathDriver.js",["./XooMLExceptions.js","./XooMLConfig.js","./XooMLUtil.js"],function(XooMLExceptions,XooMLConfig,XooMLUtil){"use strict";function PathDriver(){}var self,_PATH_SEPARATOR="/";return self=PathDriver.prototype,self.joinPath=function(rootPath,leafPath){var self=this;return rootPath===_PATH_SEPARATOR?leafPath:(rootPath=self._stripTrailingSlash(rootPath),leafPath=self._stripLeadingSlash(leafPath),rootPath+_PATH_SEPARATOR+leafPath)},self.joinPathArray=function(){throw XooMLExceptions.notImplemented},self.splitPath=function(path){return path.split(_PATH_SEPARATOR)},self.formatPath=function(path){return self._stripTrailingSlash(path)},self.isRoot=function(path){return path===_PATH_SEPARATOR},self.getPathSeparator=function(){return _PATH_SEPARATOR},self._stripTrailingSlash=function(path){var strippedPath;return path===_PATH_SEPARATOR?path:(strippedPath=path,XooMLUtil.endsWith(strippedPath,_PATH_SEPARATOR)&&(strippedPath=strippedPath.substring(0,strippedPath.length-1)),strippedPath)},self._stripLeadingSlash=function(path){var strippedPath;return path===_PATH_SEPARATOR?path:(strippedPath=path,0===path.indexOf(_PATH_SEPARATOR)&&(strippedPath=strippedPath.substring(1)),strippedPath)},new PathDriver}),define("XooMLAssociation.js",["./XooMLExceptions.js","./XooMLConfig.js","./XooMLUtil.js"],function(XooMLExceptions,XooMLConfig,XooMLUtil){"use strict";function XooMLAssociation(isGroupingItem,displayText){if(!XooMLUtil.isBoolean(isGroupingItem)||!XooMLUtil.isString(displayText))throw XooMLExceptions.invalidType;this._isGroupingItem=isGroupingItem,this._displayText=displayText}var self;return self=XooMLAssociation.prototype,self.getIsGroupingItem=function(){return this._isGroupingItem},self.getDisplayText=function(){return this._displayText},XooMLAssociation}),define("FragmentDriver.js",["./XooMLExceptions.js","./XooMLConfig.js","./XooMLUtil.js","./PathDriver.js","./XooMLAssociation.js"],function(XooMLExceptions,XooMLConfig,XooMLUtil,PathDriver){"use strict";function FragmentDriver(options,callback){if(XooMLUtil.checkCallback(callback),!options)return callback(XooMLExceptions.nullArgument);if(!XooMLUtil.isObject(options))return callback(XooMLExceptions.invalidType);var self=this;return XooMLUtil.hasOptions(_CONSTRUCTOR_CASE_1_OPTIONS,options)?(self._document=self._parseXML(options.xooMLFragmentString),callback(!1,self)):XooMLUtil.hasOptions(_CONSTRUCTOR_CASE_2_OPTIONS,options)?(self._document=self._createXooMLFragment(options.associations,options.xooMLUtilityURI,options.itemUtilityURI,options.syncUtilityURI,options.groupingItemURI),callback(!1,self)):callback(XooMLExceptions.missingParameter)}var self,_NAMESPACE_ATTRIBUTE="xmlns",_FRAGMENT="fragment",_FRAGMENT_NAMESPACE_DATA="fragmentNamespaceData",_FRAGMENT_SCHEMA_VERSION="schemaVersion",_FRAGMENT_SCHEMA_LOCATION="schemaLocation",_FRAGMENT_ITEM_DESCRIBED="itemDescribed",_ITEM_DESCRIBED=".",_FRAGMENT_ITEM_DRIVER="itemDriver",_FRAGMENT_SYNC_DRIVER="syncDriver",_FRAGMENT_XOOML_UTILITY="xooMLDriver",_FRAGMENT_GUID="GUIDGeneratedOnLastWrite",_ASSOCIATION="association",_ASSOCIATION_NAMESPACE_DATA="associationNamespaceData",_ASSOCIATION_GUID="ID",_ASSOCIATION_DISPLAY_TEXT="displayText",_ASSOCIATION_ASSOCIATED_XOOML_FRAGMENT="associatedXooMLFragment",_ASSOCIATION_ASSOCIATED_XOOML_DRIVER="associatedXooMLDriver",_ASSOCIATION_ASSOCIATED_ITEM="associatedItem",_ASSOCIATION_LOCAL_ITEM="localItem",_XML_XSI_URI="http://www.w3.org/2001/XMLSchema-instance",_DEFAULT_VALUE_FOR_ADD_ATTRIBUTE="",_CONSTRUCTOR_CASE_1_OPTIONS={xooMLFragmentString:!0},_CONSTRUCTOR_CASE_2_OPTIONS={associations:!0,xooMLUtilityURI:!0,itemUtilityURI:!0,syncUtilityURI:!0,groupingItemURI:!0};return self=FragmentDriver.prototype,self.updateETag=function(callback){var GUID,self=this;return GUID=XooMLUtil.generateGUID(),self._document.getElementsByTagName(_FRAGMENT)[0].getAttribute(_FRAGMENT_GUID),callback(!1,GUID)},self.getSchemaVersion=function(callback){var self=this;self._getAttribute(_FRAGMENT_SCHEMA_VERSION,_FRAGMENT,null,null,callback)},self.setSchemaVersion=function(schemaVersion,callback){var self=this;self._setAttribute(_FRAGMENT_SCHEMA_VERSION,schemaVersion,_FRAGMENT,null,null,callback)},self.getSchemaLocation=function(callback){var self=this;self._getAttribute(_FRAGMENT_SCHEMA_LOCATION,_FRAGMENT,null,null,callback)},self.setSchemaLocation=function(schemaLocation,callback){var self=this;self._setAttribute(_FRAGMENT_SCHEMA_LOCATION,schemaLocation,_FRAGMENT,null,null,callback)},self.getItemDescribed=function(callback){var self=this;self._getAttribute(_FRAGMENT_ITEM_DESCRIBED,_FRAGMENT,null,null,callback)},self.setItemDescribed=function(itemDescribed,callback){var self=this;self._setAttribute(_FRAGMENT_ITEM_DESCRIBED,itemDescribed,_FRAGMENT,null,null,callback)},self.getItemDriver=function(callback){var self=this;self._getAttribute(_FRAGMENT_ITEM_DRIVER,_FRAGMENT,null,null,callback)},self.setItemUtility=function(itemUtility,callback){var self=this;self._setAttribute(_FRAGMENT_ITEM_DRIVER,itemUtility,_FRAGMENT,null,null,callback)},self.getSyncDriver=function(callback){var self=this;self._getAttribute(_FRAGMENT_SYNC_DRIVER,_FRAGMENT,null,null,callback)},self.setSyncUtility=function(syncUtility,callback){var self=this;self._setAttribute(_FRAGMENT_SYNC_DRIVER,syncUtility,_FRAGMENT,null,null,callback)},self.getXooMLDriver=function(callback){var self=this;self._getAttribute(_FRAGMENT_XOOML_UTILITY,_FRAGMENT,null,null,callback)},self.setXooMLUtility=function(xooMlUtility,callback){var self=this;self._setAttribute(_FRAGMENT_XOOML_UTILITY,xooMlUtility,_FRAGMENT,null,null,callback)},self.getGUIDGeneratedOnLastWrite=function(callback){var self=this;self._getAttribute(_FRAGMENT_GUID,_FRAGMENT,null,null,callback)},self.listFragmentCommonAttributes=function(callback){var self=this;self._listAttributes(_FRAGMENT,null,null,callback)},self.getAssociationDisplayText=function(GUID,callback){var self=this;self._getAttribute(_ASSOCIATION_DISPLAY_TEXT,_ASSOCIATION,null,GUID,callback)},self.setAssociationDisplayText=function(GUID,displayName,callback){var self=this;self._setAttribute(_ASSOCIATION_DISPLAY_TEXT,displayName,_ASSOCIATION_GUID,null,GUID,callback)},self.getAssociationAssociatedXooMLFragment=function(GUID,callback){var self=this;self._getAttribute(_ASSOCIATION_ASSOCIATED_XOOML_FRAGMENT,_ASSOCIATION,null,GUID,callback)},self.setAssociationAssociatedXooMLFragment=function(GUID,associatedXooMLFragment,callback){var self=this;self._setAttribute(_ASSOCIATION_ASSOCIATED_XOOML_FRAGMENT,associatedXooMLFragment,_ASSOCIATION_GUID,null,GUID,callback)},self.getAssociationXooMLUtility=function(GUID,callback){var self=this;self._getAttribute(_ASSOCIATION_ASSOCIATED_XOOML_DRIVER,_ASSOCIATION,null,GUID,callback)},self.setAssociationXooMLUtility=function(GUID,xooMLUtility,callback){var self=this;self._setAttribute(_ASSOCIATION_ASSOCIATED_XOOML_DRIVER,xooMLUtility,_ASSOCIATION_GUID,null,GUID,callback)},self.getAssociationLocalItem=function(GUID,callback){var self=this;self._getAttribute(_ASSOCIATION_LOCAL_ITEM,_ASSOCIATION,null,GUID,callback)},self.setAssociationLocalItem=function(GUID,localItem,callback){var self=this;return self._setAttribute(_ASSOCIATION_LOCAL_ITEM,localItem,_ASSOCIATION_GUID,null,GUID,callback)},self.getAssociationAssociatedItem=function(GUID,callback){var self=this;self._getAttribute(_ASSOCIATION_ASSOCIATED_ITEM,_ASSOCIATION,null,GUID,callback)},self.setAssociationAssociatedItem=function(GUID,associatedItem,callback){var self=this;return self._setAttribute(_ASSOCIATION_ASSOCIATED_ITEM,associatedItem,_ASSOCIATION_GUID,null,GUID,callback)},self.listAssociationCommonAttributes=function(GUID,callback){var self=this;self._listAttributes(_ASSOCIATION,null,GUID,callback)},self.getFragmentNamespaceAttribute=function(attributeName,namespaceURI,callback){var self=this;self._getAttribute(attributeName,_FRAGMENT_NAMESPACE_DATA,namespaceURI,null,callback)},self.addFragmentNamespaceAttribute=function(attributeName,namespaceURI,callback){var self=this;return self._addAttribute(attributeName,_FRAGMENT_NAMESPACE_DATA,namespaceURI,null,callback)},self.removeFragmentNamespaceAttribute=function(attributeName,namespaceURI,callback){var self=this;return self._removeAttribute(attributeName,_FRAGMENT_NAMESPACE_DATA,namespaceURI,null,callback)},self.hasFragmentNamespace=function(namespaceURI,callback){var self=this;self._hasNamespace(null,namespaceURI,callback)},self.setFragmentNamespaceAttribute=function(attributeName,attributeValue,namespaceURI,callback){var self=this;return self._setAttribute(attributeName,attributeValue,_FRAGMENT_NAMESPACE_DATA,namespaceURI,null,callback)},self.listFragmentNamespaceAttributes=function(namespaceURI,callback){var self=this;self._listAttributes(_FRAGMENT_NAMESPACE_DATA,namespaceURI,null,callback)},self.getFragmentNamespaceData=function(namespaceURI,callback){var self=this;self._getNamespaceData(_FRAGMENT,namespaceURI,null,callback)},self.setFragmentNamespaceData=function(data,namespaceURI,callback){var self=this;self._setNamespaceData(_FRAGMENT,namespaceURI,null,data,callback)},self.createAssociation=function(options,callback){if(XooMLUtil.checkCallback(callback),!options)return callback(XooMLExceptions.nullArgument);if(!XooMLUtil.isObject(options))return callback(XooMLExceptions.invalidType);var GUID,isLinkNonGrouping,isSimple,isLinkGrouping,isCreate,self=this;return self._updateFragment(self._document),GUID=XooMLUtil.generateGUID(),isSimple=XooMLUtil.hasOptions(XooMLConfig.createAssociationSimple,options),isLinkNonGrouping=XooMLUtil.hasOptions(XooMLConfig.createAssociationLinkNonGrouping,options),isLinkGrouping=XooMLUtil.hasOptions(XooMLConfig.createAssociationLinkGrouping,options),isCreate=XooMLUtil.hasOptions(XooMLConfig.createAssociationCreate,options),isSimple?self._createAssociation(GUID,null,options.displayText,null,null,null,callback):isLinkNonGrouping?self._createAssociationLinkNonGrouping(GUID,options,callback):isLinkGrouping?self._createAssociationLinkGrouping(GUID,options,callback):isCreate?self._createAssociationCreate(GUID,options,callback):callback(XooMLExceptions.missingParameter)},self.deleteAssociation=function(GUID,callback){if(XooMLUtil.checkCallback(callback),!GUID)return callback(XooMLExceptions.nullArgument);if(!XooMLUtil.isGUID(GUID))return callback(XooMLExceptions.invalidType);var association,associations,i,self=this;for(associations=self._document.getElementsByTagName(_ASSOCIATION),i=0;i<associations.length;i+=1)if(association=associations[i],association.getAttribute(_ASSOCIATION_GUID)===GUID)return association.parentNode.removeChild(association),callback(!1);return callback(XooMLExceptions.invalidArgument)},self.listAssociations=function(callback){XooMLUtil.checkCallback(callback);var associations,associationNodes,associationNode,i,GUID,self=this;for(associations=[],associationNodes=self._document.getElementsByTagName(_ASSOCIATION),i=0;i<associationNodes.length;i+=1)associationNode=associationNodes[i],GUID=associationNode.getAttribute(_ASSOCIATION_GUID),associations.push(GUID);return callback(!1,associations)},self.getAssociationNamespaceAttribute=function(attributeName,GUID,namespaceURI,callback){var self=this;self._getAttribute(attributeName,_ASSOCIATION_NAMESPACE_DATA,namespaceURI,GUID,callback)},self.addAssociationNamespaceAttribute=function(attributeName,GUID,namespaceURI,callback){var self=this;self._addAttribute(attributeName,_ASSOCIATION_NAMESPACE_DATA,namespaceURI,GUID,callback)},self.removeAssociationNamespaceAttribute=function(attributeName,GUID,namespaceURI,callback){var self=this;return self._removeAttribute(attributeName,_ASSOCIATION_NAMESPACE_DATA,namespaceURI,GUID,callback)},self.setAssociationNamespaceAttribute=function(attributeName,attributeValue,GUID,namespaceURI,callback){var self=this;return self._setAttribute(attributeName,attributeValue,_ASSOCIATION_NAMESPACE_DATA,namespaceURI,GUID,callback)},self.hasAssociationNamespace=function(GUID,namespaceURI,callback){var self=this;self._hasNamespace(GUID,namespaceURI,callback)},self.listAssociationNamespaceAttributes=function(GUID,namespaceURI,callback){var self=this;self._listAttributes(_ASSOCIATION_NAMESPACE_DATA,namespaceURI,GUID,callback)},self.getAssociationNamespaceData=function(GUID,namespaceURI,callback){var self=this;self._getNamespaceData(_ASSOCIATION_NAMESPACE_DATA,namespaceURI,GUID,callback)},self.setAssociationNamespaceData=function(data,GUID,namespaceURI,callback){var self=this;self._setNamespaceData(_ASSOCIATION_NAMESPACE_DATA,namespaceURI,GUID,data,callback)},self.toString=function(callback){XooMLUtil.checkCallback(callback);var tmp,self=this;tmp=document.createElement("div"),tmp.appendChild(self._document.firstChild.cloneNode(!0)),callback(!1,tmp.innerHTML)},self._parseXML=function(xml){var parser,xmlDoc;return window.DOMParser?(parser=new DOMParser,xmlDoc=parser.parseFromString(xml,"text/xml")):(xmlDoc=new ActiveXObject("Microsoft.XMLDOM"),xmlDoc.async=!1,xmlDoc.loadXML(xml)),xmlDoc},self._createXooMLFragment=function(associations,xooMLUtilityURI,itemUtilityURI,syncUtilityURI){var fragment,document,i,association,GUID,associatedXooMLFragment,self=this;for(document=self._parseXML("<"+_FRAGMENT+"></"+_FRAGMENT+">"),fragment=document.firstChild,fragment.setAttribute("xmlns",XooMLConfig.schemaLocation),fragment.setAttribute("xmlns:xsi",_XML_XSI_URI),fragment.setAttribute(_FRAGMENT_ITEM_DRIVER,itemUtilityURI),fragment.setAttribute(_FRAGMENT_XOOML_UTILITY,xooMLUtilityURI),fragment.setAttribute(_FRAGMENT_SYNC_DRIVER,syncUtilityURI),fragment.setAttribute(_FRAGMENT_ITEM_DESCRIBED,_ITEM_DESCRIBED),fragment.setAttribute(_FRAGMENT_SCHEMA_LOCATION,XooMLConfig.schemaLocation),fragment.setAttribute(_FRAGMENT_SCHEMA_VERSION,XooMLConfig.schemaVersion),fragment.setAttribute(_FRAGMENT_GUID,XooMLUtil.generateGUID()),i=0;i<associations.length;i+=1)association=associations[i],GUID=XooMLUtil.generateGUID(),associatedXooMLFragment=association.getIsGroupingItem()?PathDriver.joinPath(association.getDisplayText(),XooMLConfig.xooMLFragmentFileName):null,self._createAssociation(GUID,associatedXooMLFragment,association.getDisplayText(),association.getDisplayText(),association.getDisplayText(),fragment);return document},self._createAssociation=function(GUID,associationXooMLFragment,displayText,associatedItem,localItem,fragment,callback){var association,parent,self=this;return parent=fragment||self._document.firstChild,localItem=localItem||"",associatedItem=associatedItem||"",associationXooMLFragment=associationXooMLFragment||"",association=self._parseXML("<"+_ASSOCIATION+"/>").firstChild,association.setAttribute(_ASSOCIATION_GUID,GUID),association.setAttribute(_ASSOCIATION_ASSOCIATED_ITEM,associatedItem),association.setAttribute(_ASSOCIATION_DISPLAY_TEXT,displayText),association.setAttribute(_ASSOCIATION_LOCAL_ITEM,localItem),association.setAttribute(_ASSOCIATION_ASSOCIATED_XOOML_FRAGMENT,associationXooMLFragment),association.setAttribute(_ASSOCIATION_ASSOCIATED_XOOML_DRIVER,""),parent.appendChild(association.cloneNode(!0)),callback?callback(!1,GUID):void 0},self._createAssociationLinkNonGrouping=function(GUID,options,callback){var self=this;return options.localItemRequested?callback(XooMLExceptions.notImplemented):self._createAssociation(GUID,null,options.displayText,options.itemURI,null,null,callback)},self._createAssociationLinkGrouping=function(GUID,options,callback){return callback(XooMLExceptions.notImplemented)},self._createAssociationCreate=function(GUID,options,callback){var self=this;options.isGroupingItem?self._createAssociation(GUID,null,options.displayText,options.itemName,options.itemName,null,callback):self._createAssociation(GUID,null,options.displayText,options.itemName,options.itemName,null,callback)},self._updateFragment=function(fragment){return fragment.getElementsByTagName(_FRAGMENT)[0].getAttribute(_FRAGMENT_GUID)},self._getOrCreateElement=function(elementName,namespaceURI,GUID,callback){if(!elementName)return callback(XooMLExceptions.nullArgument);if(GUID&&!XooMLUtil.isGUID(GUID)||namespaceURI&&!XooMLUtil.isString(namespaceURI)||!XooMLUtil.isString(elementName))return callback(XooMLExceptions.invalidType);var self=this;return null!==GUID?self._getAssociation(self._document,GUID,namespaceURI,!0):self._getFragment(self._document,namespaceURI,!0)},self._getFragment=function(documentNode,namespaceURI,createIfNotExist){var fragmentNamespaceDataNodes,fragmentNamespaceDataNode,i;if(!namespaceURI)return documentNode.firstChild;for(createIfNotExist=createIfNotExist||!0,fragmentNamespaceDataNodes=documentNode.getElementsByTagName(_FRAGMENT_NAMESPACE_DATA),i=0;i<fragmentNamespaceDataNodes.length;i+=1)if(fragmentNamespaceDataNode=fragmentNamespaceDataNodes[i],namespaceURI===fragmentNamespaceDataNode.getAttribute(_NAMESPACE_ATTRIBUTE))return fragmentNamespaceDataNode;return createIfNotExist?(fragmentNamespaceDataNode=documentNode.createElement(_FRAGMENT_NAMESPACE_DATA),fragmentNamespaceDataNode.setAttribute(_NAMESPACE_ATTRIBUTE,namespaceURI),documentNode.getElementsByTagName(_FRAGMENT)[0].appendChild(fragmentNamespaceDataNode),fragmentNamespaceDataNode):null},self._getAssociation=function(documentNode,GUID,namespaceURI,createIfNotExist){var childNodes,childNode,namespaceNodes,namespaceNode,i,j,self=this;for(createIfNotExist=createIfNotExist||!0,childNodes=documentNode.getElementsByTagName(_ASSOCIATION),i=0;i<childNodes.length;i+=1)if(childNode=childNodes[i],childNode.getAttribute(_ASSOCIATION_GUID)===GUID){if(!namespaceURI)return childNode;for(namespaceNodes=documentNode.getElementsByTagName(_ASSOCIATION_NAMESPACE_DATA),j=0;j<namespaceNodes.length;j+=1)if(namespaceNode=namespaceNodes[j],namespaceNode.getAttribute(_NAMESPACE_ATTRIBUTE)===namespaceURI&&namespaceNode.parentNode.getAttribute(_ASSOCIATION_GUID)==GUID)return namespaceNode;return createIfNotExist?self._createNewNamespaceData(documentNode,childNode,_ASSOCIATION_NAMESPACE_DATA,namespaceURI):null}return createIfNotExist?self._createNewAssociation(documentNode,GUID,namespaceURI):null},self._createNewNamespaceData=function(documentNode,commonNode,namespaceElementName,namespaceURI){var namespaceDataNode;return namespaceDataNode=documentNode.createElement(namespaceElementName),namespaceDataNode.setAttribute(_NAMESPACE_ATTRIBUTE,namespaceURI),commonNode.appendChild(namespaceDataNode),namespaceDataNode},self._createNewAssociation=function(documentNode,GUID,namespaceURI){var association,associationNamespaceData,self=this;return association=documentNode.createElement(_ASSOCIATION),association.setAttribute(_ASSOCIATION_GUID,GUID),namespaceURI&&(associationNamespaceData=self._createNewNamespaceData(documentNode,association,_ASSOCIATION_NAMESPACE_DATA,namespaceURI)),documentNode.getElementsByTagName(_FRAGMENT)[0].appendChild(association),namespaceURI?associationNamespaceData:association},self._getAttribute=function(attributeName,elementName,namespaceURI,GUID,callback){var self=this;self._retrieveAttribute(attributeName,elementName,namespaceURI,GUID,function(error,element){if(error)throw error;return callback(!1,element.getAttribute(attributeName))})},self._setAttribute=function(attributeName,attributeValue,elementName,namespaceURI,GUID,callback){var self=this;self._retrieveAttribute(attributeName,elementName,namespaceURI,GUID,function(error,element){if(error)throw error;element.setAttribute(attributeName,attributeValue),self._updateFragment(self._document),callback(!1)})},self._addAttribute=function(attributeName,elementName,namespaceURI,GUID,callback){var self=this;self._retrieveAttribute(attributeName,elementName,namespaceURI,GUID,function(error,element){if(error)throw error;return element.getAttribute(attributeName)?callback(XooMLExceptions.invalidState):(element.setAttribute(attributeName,_DEFAULT_VALUE_FOR_ADD_ATTRIBUTE),self._updateFragment(self._document),void callback(!1))})},self._removeAttribute=function(attributeName,elementName,namespaceURI,GUID,callback){var self=this;self._retrieveAttribute(attributeName,elementName,namespaceURI,GUID,function(error,element){return error?callback(error):element.getAttribute(attributeName)?(element.removeAttribute(attributeName),self._updateFragment(self._document),void callback(!1)):callback(XooMLExceptions.invalidState)})},self._retrieveAttribute=function(attributeName,elementName,namespaceURI,GUID,callback){if(XooMLUtil.checkCallback(callback),!attributeName)return callback(XooMLExceptions.nullArgument);if(!XooMLUtil.isString(attributeName))return callback(XooMLExceptions.invalidType);var element,self=this;return element=self._getOrCreateElement(elementName,namespaceURI,GUID,callback),callback(!1,element)},self._listAttributes=function(elementName,namespaceURI,GUID,callback){XooMLUtil.checkCallback(callback);var element,attributes,i,attrib,self=this;for(element=self._getOrCreateElement(elementName,namespaceURI,GUID,callback),attributes=[],i=0;i<element.attributes.length;i+=1)attrib=element.attributes[i],attributes.push(attrib.name);return callback(!1,attributes)},self._getNamespaceData=function(elementName,namespaceURI,GUID,callback){var element,self=this;return element=self._getOrCreateElement(elementName,namespaceURI,GUID,callback),callback(!1,element.innerHTML)},self._setNamespaceData=function(elementName,namespaceURI,GUID,data,callback){if(XooMLUtil.checkCallback(callback),!data)return callback(XooMLExceptions.nullArgument);if(!XooMLUtil.isString(data))return callback(XooMLExceptions.invalidType);var element,self=this;element=self._getOrCreateElement(elementName,namespaceURI,GUID,callback),element.innerHTML=data,callback(!1)},self._hasNamespace=function(GUID,namespaceURI,callback){if(XooMLUtil.checkCallback(callback),!namespaceURI)return callback(XooMLExceptions.nullArgument);if(GUID&&!XooMLUtil.isGUID(GUID))return callback(XooMLExceptions.invalidType);var element,self=this;return element=GUID?self._getAssociation(self._document,GUID,namespaceURI,!1):self._getFragment(self._document,namespaceURI,!1),callback(!1,null!==element)},FragmentDriver}),define("ItemDriver.js",["./XooMLExceptions.js","./XooMLConfig.js","./XooMLUtil.js","./XooMLAssociation.js"],function(XooMLExceptions,XooMLConfig,XooMLUtil,XooMLAssociation){"use strict";function ItemDriver(options,callback){if(XooMLUtil.checkCallback(callback),!XooMLUtil.isObject(options))return callback(XooMLExceptions.invalidType);if(!XooMLUtil.isFunction(callback))return callback(XooMLExceptions.invalidType);if(!XooMLUtil.hasOptions(_CONSTRUCTOR__OPTIONS,options))return callback(XooMLExceptions.missingParameter);var self=this;self._dropboxClient=options.dropboxClient,self._checkDropboxAuthenticated(self._dropboxClient)?callback(!1,self):self._dropboxClient.authenticate(function(error){return error?callback(XooMLExceptions.itemUException,null):callback(!1,self)})}var self,_CONSTRUCTOR__OPTIONS={driverURI:!0,dropboxClient:!0},_DIRECTORY_STAT="inode/directory";return self=ItemDriver.prototype,self.moveGroupingItem=function(fromPath,newPath,callback){var self=this;self._dropboxClient.move(fromPath,newPath,function(error){return callback(error?error:!1)})},self.isGroupingItem=function(path,callback){var self=this;self._dropboxClient.stat(path,function(error,stat){return error?self._showDropboxError(error,callback):callback(!1,stat.mimeType===_DIRECTORY_STAT)})},self.createGroupingItem=function(path,callback){var self=this;self._dropboxClient.mkdir(path,function(error,stat){return error?self._showDropboxError(error,callback):callback(!1,stat)})},self.createNonGroupingItem=function(path,file,callback){var self=this;self._dropboxClient.writeFile(path,file,function(error,stat){return error?self._showDropboxError(error,callback):callback(!1,stat)})},self.deleteGroupingItem=function(path,callback){var self=this;self._dropboxClient.remove(path,function(error,stat){return error?self._showDropboxError(error,callback):callback(!1,stat)})},self.deleteNonGroupingItem=function(path,callback){var self=this;self._dropboxClient.remove(path,function(error,stat){return error?self._showDropboxError(error,callback):callback(!1,stat)})},self.copyItem=function(fromPath,toPath,callback){var self=this;self._dropboxClient.copy(fromPath,toPath,function(error){return error?self._showDropboxError(error,callback):callback(!1)})},self.moveItem=function(fromPath,toPath,callback){var self=this;self._dropboxClient.move(fromPath,toPath,function(error){return error?self._showDropboxError(error,callback):callback(!1)})},self.getURL=function(path,callback){var self=this;self._dropboxClient.makeUrl(path,null,function(error,publicURL){return error?self._showDropboxError(error,callback):callback(!1,publicURL.url)})},self.listItems=function(path,callback){var self=this;self._dropboxClient.readdir(path,function(error,list,stat,listStat){if(error)return self._showDropboxError(error,callback);var i,output;for(output=[],i=0;i<listStat.length;i+=1)listStat[i].name!==XooMLConfig.xooMLFragmentFileName&&output.push(new XooMLAssociation(listStat[i].mimeType===_DIRECTORY_STAT,listStat[i].name));return callback(!1,output)})},self.checkExisted=function(path,callback){var result,self=this;self._dropboxClient.stat(path,function(error,stat){return error?self._showDropboxError(error,callback):(result=!(null!==error&&404===error.status)||null===error&&stat.isRemoved,callback(!1,result))})},self._showDropboxError=function(error,callback){return callback(error.status)},self._checkDropboxAuthenticated=function(dropboxClient){return 4===dropboxClient.authState},ItemDriver}),define("XooMLDriver.js",["./XooMLExceptions.js","./XooMLConfig.js","./XooMLUtil.js"],function(XooMLExceptions,XooMLConfig,XooMLUtil){"use strict";function XooMLDriver(options,callback){if(XooMLUtil.checkCallback(callback),!XooMLUtil.hasOptions(_CONSTRUCTOR_OPTIONS,options))return callback(XooMLExceptions.missingParameter);if(!XooMLUtil.isObject(options))return callback(XooMLExceptions.invalidType);var self=this;return self._dropboxClient=options.dropboxClient,self._checkDropboxAuthenticated(self._dropboxClient)?callback(!1,self):void self._dropboxClient.authenticate(function(error){return error?callback(XooMLExceptions.xooMLUException,null):callback(!1,self)})}var self,_CONSTRUCTOR_OPTIONS={driverURI:!0,dropboxClient:!0};return self=XooMLDriver.prototype,self.getXooMLFragment=function(uri,callback){var self=this;self._dropboxClient.readFile(uri,function(error,content){return error?self._showDropboxError(error,callback):void callback(!1,content)})},self.setXooMLFragment=function(uri,fragment,callback){var self=this;self._dropboxClient.writeFile(uri,fragment,function(error,stat){return error?self._showDropboxError(error,callback):void callback(!1,stat)})},self.checkExisted=function(uri,callback){var result,self=this;self._dropboxClient.stat(uri,function(error,stat){return error?self._showDropboxError(error,callback):(result=null!==error&&404===error.status||null===error&&stat.isRemoved===!0?!1:!0,void callback(!1,result))})},self._showDropboxError=function(error,callback){return callback(error.status)},self._checkDropboxAuthenticated=function(dropboxClient){return 4===dropboxClient.authState},XooMLDriver}),define("SyncDriver.js",["./XooMLExceptions.js","./XooMLConfig.js","./XooMLUtil.js"],function(){"use strict";function SyncDriver(itemMirror){var self=this;self._itemMirror=itemMirror,self._fragmentDriver=itemMirror._fragmentDriver,self._itemDriver=itemMirror._itemDriver}var self;return self=SyncDriver.prototype,self.sync=function(callback){var compXooML,compItem,self=this,compXooMLLocalItem=[];self._fragmentDriver.listAssociations(function(error,list){return error?callback(error):(compXooML=list,void self._itemMirror.getGroupingItemURI(function(error,groupingItemURI){return error?callback(error):void self._itemDriver.listItems(groupingItemURI,function(error,list){return error?callback(error):(compItem=list,void self._getLocalItems(compXooML,compItem,compXooMLLocalItem,0,callback))})}))})},self._getLocalItems=function(compXooML,compItem,compXooMLLocalItem,i,callback){var self=this;0===compXooML.length?self._removeNonLocalItems(compXooML,compItem,compXooMLLocalItem,0,callback):self._itemMirror.getAssociationLocalItem(compXooML[i],function(error,item){return error?callback(error):(compXooMLLocalItem.push(item),i++,void(i<compXooML.length?self._getLocalItems(compXooML,compItem,compXooMLLocalItem,i,callback):self._removeNonLocalItems(compXooML,compItem,compXooMLLocalItem,0,callback)))})},self._removeNonLocalItems=function(compXooML,compItem,compXooMLLocalItem,i,callback){var self=this;if(void 0!==compXooMLLocalItem[i]&&null!==compXooMLLocalItem[i]&&""!==compXooMLLocalItem[i]){for(var found=0,j=0;j<compItem.length;j++)if(compXooMLLocalItem[i]===compItem[j].getDisplayText()){compItem.splice(j,1),found=1;
break}0===found?(console.log("Sync Remove: "+compXooMLLocalItem[i]),self._fragmentDriver.deleteAssociation(compXooML[i],function(error){return error?callback(error):(i++,void(i<compXooMLLocalItem.length?self._removeNonLocalItems(compXooML,compItem,compXooMLLocalItem,i,callback):self._createNewLocalItems(compXooML,compItem,compXooMLLocalItem,0,callback)))})):(i++,i<compXooMLLocalItem.length?self._removeNonLocalItems(compXooML,compItem,compXooMLLocalItem,i,callback):self._createNewLocalItems(compXooML,compItem,compXooMLLocalItem,0,callback))}else i++,i<compXooMLLocalItem.length?self._removeNonLocalItems(compXooML,compItem,compXooMLLocalItem,i,callback):self._createNewLocalItems(compXooML,compItem,compXooMLLocalItem,0,callback)},self._createNewLocalItems=function(compXooML,compItem,compXooMLLocalItem,i,callback){var self=this;0===compItem.length?self._itemMirror._save(callback):(console.log("Sync Create: "+compItem[i].getDisplayText()),self._fragmentDriver.createAssociation({displayText:compItem[i].getDisplayText(),isGroupingItem:compItem[i].getIsGroupingItem(),itemName:compItem[i].getDisplayText()},function(error){return error?callback(error):(i++,void(i<compItem.length?self._createNewLocalItems(compXooML,compItem,compXooMLLocalItem,i,callback):self._itemMirror._save(callback)))}))},SyncDriver}),define("ItemMirror",["./XooMLExceptions.js","./XooMLConfig.js","./XooMLUtil.js","./PathDriver.js","./FragmentDriver.js","./ItemDriver.js","./XooMLDriver.js","./SyncDriver.js"],function(XooMLExceptions,XooMLConfig,XooMLUtil,PathDriver,FragmentDriver,ItemDriver,XooMLDriver,SyncDriver){"use strict";function ItemMirror(options,callback){if(XooMLUtil.checkCallback(callback),!options)return callback(XooMLExceptions.nullArgument);if(!XooMLUtil.isObject(options))return callback(XooMLExceptions.invalidType);if(!XooMLUtil.hasOptions(_CONSTRUCTOR_CASE_2_AND_3_OPTIONS,options)&&!XooMLUtil.hasOptions(_CONSTRUCTOR_CASE_1_OPTIONS,options))return callback(XooMLExceptions.missingParameter);var xooMLFragmentURI,self=this;self._xooMLDriver=null,self._itemDriver=null,self._syncDriver=null,self._fragmentDriver=null,self._parent=options.parent,self._groupingItemURI=PathDriver.formatPath(options.groupingItemURI),self._newItemMirrorOptions=options,xooMLFragmentURI=PathDriver.joinPath(self._groupingItemURI,XooMLConfig.xooMLFragmentFileName),new XooMLDriver(options.xooMLDriver,function(error,xooMLU){self._xooMLDriver=xooMLU,self._getItemU(xooMLFragmentURI,options,function(error){return error?callback(error):void self._save(function(error){return error?callback(error):(self._newItemMirrorOptions.hasOwnProperty("syncDriver")||(self._newItemMirrorOptions.syncDriver={utilityURI:"MirrorSyncUtility"}),self._newItemMirrorOptions.groupingItemURI=null,callback(!1,self))})})})}var self,_CONSTRUCTOR_CASE_1_OPTIONS={groupingItemURI:!0,xooMLDriver:!0,itemDriver:!0,parent:!1},_CONSTRUCTOR_CASE_2_AND_3_OPTIONS={groupingItemURI:!0,xooMLDriver:!0,itemDriver:!0,syncDriver:!0,readIfExists:!0,parent:!1},_UPGRADE_ASSOCIATION_OPTIONS={GUID:!0,localItemURI:!1};return self=ItemMirror.prototype,self.getGroupingItemURI=function(callback){var self=this;return callback(!1,self._groupingItemURI)},self.getDisplayName=function(callback){var displayName,self=this;return PathDriver.isRoot(self._groupingItemURI)?displayName="":(displayName=PathDriver.formatPath(self._groupingItemURI),displayName=PathDriver.splitPath(displayName),displayName=displayName[displayName.length-1]),callback(!1,displayName)},self.getSchemaVersion=function(callback){var self=this;self._fragmentDriver.getSchemaVersion(callback)},self.getSchemaLocation=function(callback){var self=this;self._fragmentDriver.getSchemaLocation(callback)},self.getItemDescribed=function(callback){var self=this;self._fragmentDriver.getItemDescribed(callback)},self.getItemDriver=function(callback){var self=this;self._fragmentDriver.getItemDriver(callback)},self.getSyncDriver=function(callback){var self=this;self._fragmentDriver.getSyncDriver(callback)},self.getURLForAssociatedNonGroupingItem=function(GUID,callback){var self=this;return XooMLUtil.checkCallback(callback),GUID?XooMLUtil.isGUID(GUID)?void self.getAssociationLocalItem(GUID,function(error,localItem){var path;return error?callback(error):(path=PathDriver.joinPath(self._groupingItemURI,localItem),void self._itemDriver.checkExisted(path,function(error,result){return error?callback(error):result===!0?self._itemDriver.getURL(path,function(error,publicURL){return error?callback(error):callback(!1,publicURL)}):callback(XooMLExceptions.invalidState)}))}):callback(XooMLExceptions.invalidType):callback(XooMLExceptions.nullArgument)},self.getXooMLDriver=function(callback){var self=this;self._fragmentDriver.getXooMLDriver(callback)},self.getGUIDGeneratedOnLastWrite=function(callback){var self=this;self._fragmentDriver.getGUIDGeneratedOnLastWrite(callback)},self.getAssociationDisplayText=function(GUID,callback){var self=this;self._fragmentDriver.getAssociationDisplayText(GUID,callback)},self.setAssociationDisplayText=function(GUID,displayText,callback){var self=this;self._fragmentDriver.setAssociationDisplayText(GUID,displayText,function(error){self._handleSet(error,callback)})},self.getAssociationAssociatedXooMLFragment=function(GUID,callback){var self=this;self._fragmentDriver.getAssociationAssociatedXooMLFragment(GUID,callback)},self.getAssociationLocalItem=function(GUID,callback){var self=this;self._fragmentDriver.getAssociationLocalItem(GUID,callback)},self.getAssociationAssociatedItem=function(GUID,callback){var self=this;self._fragmentDriver.getAssociationAssociatedItem(GUID,callback)},self.getFragmentNamespaceAttribute=function(attributeName,namespaceURI,callback){var self=this;self._fragmentDriver.getFragmentNamespaceAttribute(attributeName,namespaceURI,callback)},self.addFragmentNamespaceAttribute=function(attributeName,namespaceURI,callback){var self=this;self._fragmentDriver.addFragmentNamespaceAttribute(attributeName,namespaceURI,callback)},self.removeFragmentNamespaceAttribute=function(attributeName,namespaceURI,callback){var self=this;self._fragmentDriver.removeFragmentNamespaceAttribute(attributeName,namespaceURI,callback)},self.hasFragmentNamespace=function(namespaceURI,callback){var self=this;self._fragmentDriver.hasFragmentNamespace(namespaceURI,callback)},self.setFragmentNamespaceAttribute=function(attributeName,attributeValue,namespaceURI,callback){var self=this;self._fragmentDriver.setFragmentNamespaceAttribute(attributeName,attributeValue,namespaceURI,function(error){self._handleSet(error,callback)})},self.listFragmentNamespaceAttributes=function(namespaceURI,callback){var self=this;self._fragmentDriver.listFragmentNamespaceAttributes(namespaceURI,callback)},self.getFragmentNamespaceData=function(namespaceURI,callback){var self=this;self._fragmentDriver.getFragmentNamespaceData(namespaceURI,callback)},self.setFragmentNamespaceData=function(data,namespaceURI,callback){var self=this;self._fragmentDriver.setFragmentNamespaceData(data,namespaceURI,function(error){self._handleSet(error,callback)})},self.createItemMirrorForAssociatedGroupingItem=function(GUID,callback){var self=this;self.isAssociatedItemGrouping(GUID,function(error,isGrouping){return error?callback(error):isGrouping?void self._fragmentDriver.getAssociationAssociatedItem(GUID,function(error,associatedItem){if(error)return callback(error);var associatedXooMLFragment;associatedXooMLFragment=PathDriver.joinPath(associatedItem,XooMLConfig.xooMLFragmentFileName),self._fragmentDriver.setAssociationAssociatedXooMLFragment(GUID,associatedXooMLFragment,function(error){if(error)return callback(error);var path,itemMirrorOptions;path=PathDriver.joinPath(self._groupingItemURI,associatedItem),itemMirrorOptions=self._newItemMirrorOptions,itemMirrorOptions.groupingItemURI=path,itemMirrorOptions.readIfExists=!0,itemMirrorOptions.parent=self,new ItemMirror(itemMirrorOptions,function(error,itemMirror){return error?callback(error):void self.sync(function(error){if(error)throw error;return callback(!1,itemMirror)})})})}):callback(!1,null)})},self.createAssociation=function(options,callback){var isSimple,isLinkNonGrouping,isLinkGrouping,isCreate,self=this;if(!XooMLUtil.isFunction(callback))throw XooMLExceptions.invalidType;return XooMLUtil.isObject(options)?(isSimple=XooMLUtil.hasOptions(XooMLConfig.createAssociationSimple,options),isLinkNonGrouping=XooMLUtil.hasOptions(XooMLConfig.createAssociationLinkNonGrouping,options),isLinkGrouping=XooMLUtil.hasOptions(XooMLConfig.createAssociationLinkGrouping,options),isCreate=XooMLUtil.hasOptions(XooMLConfig.createAssociationCreate,options),void self._fragmentDriver.createAssociation(options,function(error,GUID){return error?callback(error):isSimple?void self._createAssociationSimple(GUID,options,callback):isLinkNonGrouping?self._createAssociationLinkNonGrouping(GUID,options,callback):isLinkGrouping?self._createAssociationLinkGrouping(GUID,options,callback):isCreate?self._createAssociationCreate(GUID,options,callback):callback(XooMLExceptions.missingParameter)})):callback(XooMLExceptions.invalidType)},self.cutAssociation=function(GUID,callback){var self=this;return XooMLUtil.checkCallback(callback),GUID?XooMLUtil.isGUID(GUID)?callback(!1,self,GUID,!0):callback(XooMLExceptions.invalidType):callback(XooMLExceptions.nullArgument)},self.copyAssociation=function(GUID,callback){var self=this;return XooMLUtil.checkCallback(callback),GUID?XooMLUtil.isGUID(GUID)?callback(!1,self,GUID,!1):callback(XooMLExceptions.invalidType):callback(XooMLExceptions.nullArgument)},self.pasteAssociation=function(ItemMirror,GUID,cut,callback){var self=this;return XooMLUtil.checkCallback(callback),GUID?XooMLUtil.isGUID(GUID)?void(cut?ItemMirror.moveAssociation(GUID,self,function(error){return callback(error?error:!1)}):ItemMirror.duplicateAssociation(GUID,self,function(error){return callback(error?error:!1)})):callback(XooMLExceptions.invalidType):callback(XooMLExceptions.nullArgument)},self.duplicateAssociation=function(GUID,ItemMirror,callback){var self=this;return XooMLUtil.checkCallback(callback),GUID?XooMLUtil.isGUID(GUID)?void self.getAssociationLocalItem(GUID,function(error,localItem){if(error)return callback(error);if(!localItem){var options={};return self.getAssociationDisplayText(GUID,function(error,displayText){return error?callback(error):(options.displayText=displayText,void self.getAssociationAssociatedItem(GUID,function(error,associatedItem){return error?callback(error):void(options.itemURI=associatedItem)}))}),ItemMirror.createAssociation(options,function(error){return error?callback(error):void 0}),ItemMirror._save(callback)}self._handleDataWrapperCopyAssociation(GUID,localItem,ItemMirror,error,callback)}):callback(XooMLExceptions.invalidType):callback(XooMLExceptions.nullArgument)},self.moveAssociation=function(GUID,ItemMirror,callback){var self=this;return XooMLUtil.checkCallback(callback),GUID?XooMLUtil.isGUID(GUID)?void self.getAssociationLocalItem(GUID,function(error,localItem){if(error)return callback(error);if(!localItem){var options={};return self.getAssociationDisplayText(GUID,function(error,displayText){return error?callback(error):(options.displayText=displayText,void self.getAssociationAssociatedItem(GUID,function(error,associatedItem){return error?callback(error):void(options.itemURI=associatedItem)}))}),ItemMirror.createAssociation(options,function(error){return error?callback(error):void self._fragmentDriver.deleteAssociation(GUID,function(error){return error?callback(error):self._save(callback)})}),self._save(callback)}self._handleDataWrapperMoveAssociation(GUID,localItem,ItemMirror,error,callback)}):callback(XooMLExceptions.invalidType):callback(XooMLExceptions.nullArgument)},self.deleteAssociation=function(GUID,callback){var self=this;return XooMLUtil.checkCallback(callback),GUID?XooMLUtil.isGUID(GUID)?void self.getAssociationLocalItem(GUID,function(error,localItem){return error?callback(error):void self._fragmentDriver.deleteAssociation(GUID,function(error){return error?callback(error):localItem?void self._handleDataWrapperDeleteAssociation(GUID,localItem,error,callback):self._save(callback)})}):callback(XooMLExceptions.invalidType):callback(XooMLExceptions.nullArgument)},self.upgradeAssociation=function(options,callback){var self=this;return XooMLUtil.checkCallback(callback),XooMLUtil.hasOptions(_UPGRADE_ASSOCIATION_OPTIONS,options)?options.hasOwnProperty("localItemURI")&&!XooMLUtil.isString(options.localItemURI)||!XooMLUtil.isGUID(options.GUID)?callback(XooMLExceptions.invalidType):void(options.hasOwnProperty("localItemURI")?self._getSubGroupingItemURIFromDisplayText(options.GUID,options.localItemURI,callback):self.getAssociationDisplayText(options.GUID,function(error,displayText){return error?callback(error):void self._getSubGroupingItemURIFromDisplayText(options.GUID,displayText,callback)})):callback(XooMLExceptions.missingParameter)},self.renameLocalItem=function(GUID,newName,callback){var self=this;return XooMLUtil.checkCallback(callback),GUID?XooMLUtil.isGUID(GUID)?void self.getAssociationLocalItem(GUID,function(error,localItem){return error?callback(error):localItem?void self._handleDataWrapperRenameAssociation(GUID,localItem,newName,error,callback):callback(error)}):callback(XooMLExceptions.invalidType):callback(XooMLExceptions.nullArgument)},self.isAssociatedItemGrouping=function(GUID,callback){var self=this;self._fragmentDriver.getAssociationAssociatedItem(GUID,function(error,associatedItem){if(error)return callback(error);if(!associatedItem||""===associatedItem)return callback(!1,!1);if(self._isURL(associatedItem))return callback(!1,!1);var path;path=PathDriver.joinPath(self._groupingItemURI,associatedItem),self._itemDriver.isGroupingItem(path,function(error,result){return error?callback(error):callback(!1,result)})})},self.listAssociations=function(callback){var self=this;self._fragmentDriver.listAssociations(callback)},self.getAssociationNamespaceAttribute=function(attributeName,GUID,namespaceURI,callback){var self=this;self._fragmentDriver.getAssociationNamespaceAttribute(attributeName,GUID,namespaceURI,callback)},self.addAssociationNamespaceAttribute=function(attributeName,GUID,namespaceURI,callback){var self=this;self._fragmentDriver.addAssociationNamespaceAttribute(attributeName,GUID,namespaceURI,callback)},self.removeAssociationNamespaceAttribute=function(attributeName,GUID,namespaceURI,callback){var self=this;self._fragmentDriver.removeAssociationNamespaceAttribute(attributeName,GUID,namespaceURI,callback)},self.hasAssociationNamespace=function(GUID,namespaceURI,callback){var self=this;self._fragmentDriver.hasAssociationNamespace(GUID,namespaceURI,callback)},self.setAssociationNamespaceAttribute=function(attributeName,attributeValue,GUID,namespaceURI,callback){var self=this;self._fragmentDriver.setAssociationNamespaceAttribute(attributeName,attributeValue,GUID,namespaceURI,function(error){self._handleSet(error,callback)})},self.listAssociationNamespaceAttributes=function(GUID,namespaceURI,callback){var self=this;self._fragmentDriver.listAssociationNamespaceAttributes(GUID,namespaceURI,callback)},self.getAssociationNamespaceData=function(GUID,namespaceURI,callback){var self=this;self._fragmentDriver.getAssociationNamespaceData(GUID,namespaceURI,callback)},self.setAssociationNamespaceData=function(data,GUID,namespaceURI,callback){var self=this;self._fragmentDriver.setAssociationNamespaceData(data,GUID,namespaceURI,function(error){self._handleSet(error,callback)})},self.sync=function(callback){var self=this;self._syncDriver.sync(callback)},self.isCurrent=function(callback){var inMemoryGUID,fileGUID,xooMLFragmentURI,self=this;self.getGUIDGeneratedOnLastWrite(function(error,GUID){return error?callback(error):(inMemoryGUID=GUID,xooMLFragmentURI=PathDriver.joinPath(self._groupingItemURI,XooMLConfig.xooMLFragmentFileName),void self._xooMLDriver.getXooMLFragment(xooMLFragmentURI,function(error,content){return error?callback(error):void new FragmentDriver({xooMLFragmentString:content},function(error,tempDataWrapper){tempDataWrapper.getGUIDGeneratedOnLastWrite(function(error,GUID){return error?callback(error):(fileGUID=GUID,void callback(!1,inMemoryGUID===fileGUID))})})}))})},self.refresh=function(callback){var xooMLFragmentPath,self=this;self.isCurrent(function(error,isCurrent){if(error)throw error;return isCurrent?callback(!1):(xooMLFragmentPath=PathDriver.joinPath(self._groupingItemURI,XooMLConfig.xooMLFragmentFileName),void self._loadXooMLFragmentString(xooMLFragmentPath,callback))})},self.toString=function(callback){var self=this;self._fragmentDriver.toString(callback)},self.getParent=function(callback){var self=this;return callback(!1,self._parent)},self._getSubGroupingItemURIFromDisplayText=function(GUID,displayText,callback){var length,subGroupingItemURI,path,self=this;length=displayText.length<=XooMLConfig.maxFileLength?displayText.length:XooMLConfig.maxFileLength,subGroupingItemURI=displayText.substring(0,length),path=PathDriver.joinPath(self._groupingItemURI,subGroupingItemURI),self._itemDriver.createGroupingItem(path,function(error){return error?callback(error):void self._setAssociationLocalItemAndAssociatedItem(GUID,subGroupingItemURI,callback)})},self._setAssociationLocalItemAndAssociatedItem=function(GUID,itemURI,callback){var self=this;self._fragmentDriver.setAssociationLocalItem(GUID,itemURI,function(error){return error?callback(error):void self._fragmentDriver.setAssociationAssociatedItem(GUID,itemURI,function(error){return error?callback(error):void self._save(callback)})})},self._save=function(callback){var self=this;self.isCurrent(function(error,isCurrent){return error?callback(error):isCurrent?void self._saveFragment(callback):callback(XooMLExceptions.itemMirrorNotCurrent)})},self._saveFragment=function(callback){var self=this;self._fragmentDriver.updateETag(function(error){return error?callback(error):void self._fragmentDriver.toString(function(error,toString){if(error)return callback(error);var xooMLFragmentPath=PathDriver.joinPath(self._groupingItemURI,XooMLConfig.xooMLFragmentFileName);self._xooMLDriver.setXooMLFragment(xooMLFragmentPath,toString,function(error){return error?callback(error):void callback(!1)})})})},self._getItemU=function(xooMLFragmentURI,options,callback){var self=this;self._itemDriver=new ItemDriver(options.itemDriver,function(error,itemU){return error?callback(error,null):(self._itemDriver=itemU,void(XooMLUtil.hasOptions(_CONSTRUCTOR_CASE_2_AND_3_OPTIONS,options)?options.readIfExists?self._getItemUForFallbackConstructor(xooMLFragmentURI,options,callback):self._getItemUNewXooMLFragment(xooMLFragmentURI,options,callback):XooMLUtil.hasOptions(_CONSTRUCTOR_CASE_1_OPTIONS,options)&&self._loadXooMLFragmentString(xooMLFragmentURI,callback)))})},self._createSyncDriver=function(){var self=this;return new SyncDriver(self)},self._loadXooMLFragmentString=function(uri,callback){var self=this;self._xooMLDriver.getXooMLFragment(uri,function(error,content){return error?callback(error,null):void new FragmentDriver({xooMLFragmentString:content},function(error,fragmentWrapper){return error?callback(error):(self._fragmentDriver=fragmentWrapper,self._syncDriver=self._createSyncDriver(),void self.sync(function(error){if(error)throw error;return callback(!1,self)}))})})},self._getItemList=function(options,callback){var self=this;self._itemDriver.listItems(self._groupingItemURI,function(error,list){return error?callback(error,null):void self._createXooMLFragment(options,list,callback)})},self._createXooMLFragment=function(options,list,callback){var fragmentWrapperOptions,self=this;fragmentWrapperOptions={associations:list,xooMLUtilityURI:options.xooMLDriver.driverURI,itemUtilityURI:options.itemDriver.driverURI,syncUtilityURI:options.syncDriver.driverURI,groupingItemURI:options.groupingItemURI},new FragmentDriver(fragmentWrapperOptions,function(error,fragmentWrapper){return error?callback(error,null):(self._fragmentDriver=fragmentWrapper,self._syncDriver=self._createSyncDriver(),void self._saveFragment(callback))})},self._handleExistingAssociationDelete=function(GUID,item,callback){var path,self=this;path=PathDriver.joinPath(self._groupingItemURI,item),self._itemDriver.isGroupingItem(path,function(error,result){return error?callback(error,null):void(result===!0?self._removeNonGroupingItemThroughAssociation(GUID,item,callback):self._removeGroupingItemThroughAssociation(GUID,item,callback))})},self._handleExistingAssociationCopy=function(GUID,item,ItemMirror,callback){var pathFrom,pathTo,self=this;pathFrom=PathDriver.joinPath(self._groupingItemURI,item),pathTo=PathDriver.joinPath(ItemMirror._groupingItemURI,item),self._itemDriver.copyItem(pathFrom,pathTo,function(error){return error?self._handleSet(error,callback):callback(!1)})},self._handleExistingAssociationMove=function(GUID,item,ItemMirror,callback){var pathFrom,pathTo,self=this;pathFrom=PathDriver.joinPath(self._groupingItemURI,item),pathTo=PathDriver.joinPath(ItemMirror._groupingItemURI,item),self._itemDriver.moveItem(pathFrom,pathTo,function(error){return error?self._handleSet(error,callback):callback(!1)})},self._handleExistingAssociationRename=function(GUID,item1,item2,callback){var pathFrom,pathTo,self=this;pathFrom=PathDriver.joinPath(self._groupingItemURI,item1),pathTo=PathDriver.joinPath(self._groupingItemURI,item2),self._itemDriver.moveItem(pathFrom,pathTo,function(error){return error?self._handleSet(error,callback):callback(!1)})},self._removeNonGroupingItemThroughAssociation=function(GUID,item,callback){var path,self=this;path=PathDriver.joinPath(self._groupingItemURI,item),self._itemDriver.deleteNonGroupingItem(path,function(error){self._handleSet(error,callback)})},self._removeGroupingItemThroughAssociation=function(GUID,item,callback){var path,self=this;path=PathDriver.joinPath(self._groupingItemURI,item),self._itemDriver.deleteGroupingItem(path,function(error){self._handleSet(error,callback)})},self._handleSet=function(error,callback){if(error)return callback(error,null);var self=this;self._save(callback)},self._getItemUForFallbackConstructor=function(xooMLFragmentURI,options,callback){var self=this;self._xooMLDriver.checkExisted(xooMLFragmentURI,function(error,result){result===!0?self._loadXooMLFragmentString(xooMLFragmentURI,callback):self._getItemList(options,callback)})},self._getItemUNewXooMLFragment=function(xooMLFragmentURI,options,callback){var self=this;self._xooMLDriver.checkExisted(xooMLFragmentURI,function(error,result){return result===!0?callback(XooMLExceptions.itemAlreadyExists):void self._getItemList(options,callback)})},self._createAssociationSimple=function(GUID,options,callback){var self=this;return self._save(function(error){return callback(error,GUID)})},self._createAssociationLinkNonGrouping=function(GUID,options,callback){var self=this;return options.localItemRequested?callback(XooMLExceptions.notImplemented):self._save(function(error){return callback(error,GUID)})},self._createAssociationLinkGrouping=function(GUID,options,callback){return!options.localItemRequested,callback(XooMLExceptions.notImplemented)},self._createAssociationCreate=function(GUID,options,callback){var self=this;return options.isGroupingItem?self._createAssociationGroupingItem(GUID,options,callback):self._createAssociationNonGroupingItem(GUID,options,callback)},self._createAssociationGroupingItem=function(GUID,options,callback){var path,self=this;path=PathDriver.joinPath(self._groupingItemURI,options.itemName),self._itemDriver.createGroupingItem(path,function(error,stat){return error||stat.name!==options.itemName?callback(error,null):self._saveAssociationAssociatedXooMLFragment(GUID,options,callback)})},self._saveAssociationAssociatedXooMLFragment=function(GUID,options,callback){var self=this;self._fragmentDriver.setAssociationAssociatedXooMLFragment(GUID,XooMLConfig.xooMLFragmentFileName,function(error){return error?callback(error):void self._save(function(error){callback(error,GUID)})})},self._createAssociationNonGroupingItem=function(GUID,options,callback){var self=this;self._checkExistenceFromItemDescribed(function(error,result){return error?callback(error,null):result?callback(XooMLExceptions.itemUException):void self._createNonGroupingItemFromItemDescribed(GUID,options,callback)})},self._createNonGroupingItemFromItemDescribed=function(GUID,options,callback){var path,self=this;path=PathDriver.joinPath(self._groupingItemURI,options.itemName),self._itemDriver.createNonGroupingItem(path,"",function(error,stat){return error||stat.name===options.itemName?callback(error,null):void self._save(function(error){callback(error,GUID)})})},self._checkExistenceFromItemDescribed=function(itemName,callback){var path,self=this;path=PathDriver.joinPath(self._groupingItemURI,itemName),self._itemDriver.checkExisted(path,function(error,result){return error?callback(error,null):callback(error,result,self._groupingItemURI)})},self._handleDataWrapperDeleteAssociation=function(GUID,localItem,error,callback){var path,self=this;return error?callback(error):(path=PathDriver.joinPath(self._groupingItemURI,localItem),void self._itemDriver.checkExisted(path,function(error,result){return error?callback(error):result===!0?self._handleExistingAssociationDelete(GUID,localItem,callback):callback(XooMLExceptions.invalidState)}))},self._handleDataWrapperCopyAssociation=function(GUID,localItem,ItemMirror,error,callback){var path,self=this;return error?callback(error):(path=PathDriver.joinPath(self._groupingItemURI,localItem),void self._itemDriver.checkExisted(path,function(error,result){return error?callback(error):result===!0?self._handleExistingAssociationCopy(GUID,localItem,ItemMirror,callback):callback(XooMLExceptions.invalidState)}))},self._handleDataWrapperMoveAssociation=function(GUID,localItem,ItemMirror,error,callback){var path,self=this;return error?callback(error):(path=PathDriver.joinPath(self._groupingItemURI,localItem),void self._itemDriver.checkExisted(path,function(error,result){return error?callback(error):result===!0?self._handleExistingAssociationMove(GUID,localItem,ItemMirror,callback):callback(XooMLExceptions.invalidState)}))},self._handleDataWrapperRenameAssociation=function(GUID,localItem,newName,error,callback){var path,self=this;return error?callback(error):(path=PathDriver.joinPath(self._groupingItemURI,localItem),void self._itemDriver.checkExisted(path,function(error,result){return error?callback(error):result===!0?self._handleExistingAssociationRename(GUID,localItem,newName,callback):callback(XooMLExceptions.invalidState)}))},self._isURL=function(URL){return/^http:\/\//.exec(URL)},ItemMirror});